<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Aplikasi Mahallah TV</title>
  <link rel="icon" href="data:,">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <script src="stb-compatibility.js"></script>
  <script src="stb-optimizer.js"></script>
  <!-- Sertakan prayTimes.js secara lokal -->
  <script src="prayTimes.js"></script>
  <script src="hijri-calendar.js"></script>
  <script src="hariislam.js"></script>
  <script src="ayathadits.js"></script>

  <!-- Screen Manager -->
  <script src="screen-manager.js"></script>
  <style>

    /* CSS untuk tema warna */
    :root {
        --theme-primary: #005a31;
        --theme-primary-rgb: 0, 90, 49;
    }

    /* Hilangkan scrollbar vertikal dan horizontal */
    html, body {
        overflow: hidden;
        width: 100%;
        height: 100%;
        background-color: #f8f9fa;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--theme-primary) 0%, 
               rgba(var(--theme-primary-rgb), 0.8) 100%) !important;
      color: #fff;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1000;
    }
    .header img {
      max-height: 50px;
      border-radius: 8px;
    }

    /* Media Container */
    .media-container {
        display: flex;
        height: calc(100vh - 180px);
        overflow: hidden;
        background: white;
    }

    /* Frame Kiri (30%) */
    .media-left {
        width: 30%;
        background: black;
        overflow: hidden;
    }

    /* Frame Kanan (70%) */
    .media-right {
        width: 70%;
        position: relative;
    }

    /* Carousel Kanan */
    #mainCarousel {
      height: 100%;
    }

    .carousel-item {
      height: 100%;
      position: relative;
    }

    .carousel-item img {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }

    /* Carousel Kiri */
    #leftCarousel {
      height: 100%;
      background: linear-gradient(135deg, var(--theme-primary) 0%, 
               rgba(var(--theme-primary-rgb), 1) 100%) !important;
      }

    #leftCarousel .carousel-item {
      height: 100%;
      padding: 10px;
    }

    /* Tambahkan di bagian CSS */
    #leftCarousel .carousel-indicators {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        z-index: 2;
        display: flex;
        justify-content: center;
        padding: 0;
        margin: 0;
        list-style: none;
    }

    #leftCarousel .carousel-indicators button {
        width: 10px;
        height: 10px;
        margin: 0 5px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.5);
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    /* Tambahkan di bagian CSS */
    #leftCarousel .carousel-item,
    #mainCarousel .carousel-item {
        pointer-events: none !important; /* Mencegah click events */
    }

    #leftCarousel .carousel-item .left-card,
    #mainCarousel .carousel-item img {
        pointer-events: none !important; /* Pastikan child elements juga tidak bisa diklik */
    }

    /* Biarkan hanya carousel indicators yang bisa diklik */
    #leftCarousel .carousel-indicators button,
    #mainCarousel .carousel-indicators button {
        pointer-events: auto !important;
        cursor: pointer !important;
    }

    .left-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-size: 16px; /* Ukuran default */
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .left-card .card-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Judul setiap slide */
    .left-card h5 {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 15px;
    }

    .left-card h5 i {
        font-size: 20px;
        margin-right: 8px;
    }

    /* Teks pesan di Slide 1 */
    #slide1 .left-card .card-body > div {
        font-size: 18px;
        line-height: 1.6;
    }

    /* Alert boxes di semua slide */
    .left-card .alert {
        font-size: 16px;
        padding: 12px 15px ;
        line-height: 1.5;
    }

    /* Khusus untuk alert di Slide 2 (Hari Besar Islam) */
    #slide2 .alert-success {
        font-size: 17px;
        font-weight: 500;
    }

    /* Konten ayat hadits di Slide 3 */
    #slide3 small.text-muted {
        font-size: 14px;
        display: block;
        margin-bottom: 10px;
    }

    /* Teks ayat (Arabic) di Slide 3 */
    #slide3 div[style*="direction: rtl"] {
        font-size: 16px; /* Ukuran untuk teks Arabic */
        font-weight: 500;
        line-height: 1.8;
        margin: 15px 0;
    }

    /* Terjemahan ayat di Slide 3 */
    #slide3 div[style*="font-style: italic"] {
        font-size: 16px;
        line-height: 1.5;
        padding-top: 15px;
    }

    /* Alert di Slide 4 (Hari Besar Mendatang) */
    #slide4 .alert-info .fw-bold {
        font-size: 17px;
    }

    #slide4 .alert-info div:not(.fw-bold) {
        font-size: 16px;
        margin: 5px 0;
    }

    #slide4 .alert-info small.text-muted {
        font-size: 14px;
    }

    /* Text muted di semua slide */
    .left-card .text-muted {
        font-size: 14px;
    }

    /* Jadwal Adzan */
    .adzan-table {
      position: fixed;
      bottom: 30px;
      left: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      z-index: 1000;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .adzan-table th {
      background: var(--theme-primary) !important;
      color: white;
      font-weight: 600;
      padding: 5px 5px;
      font-size: 20px;
      border: none !important;
    }

    .adzan-table td {
      padding: 15px 5px;
      font-size: 40px;
      font-weight: bold;
      color: #333;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      border: none !important;
    }

    .adzan-table .table > :not(caption) > * > * {
      border: none !important;
    }

    .adzan-table .table-bordered > :not(caption) > * {
      border: none !important;
    }

    .adzan-table td.active {
      background: var(--theme-primary) !important;
      color: white !important;
    }

    /* Running text */
    .marquee {
      position: fixed;
      bottom: -5px;
      left: 0;
      width: 100%;
      background: linear-gradient(135deg, var(--theme-primary) 0%, 
               rgba(var(--theme-primary-rgb), 1) 100%) !important;
      color: white;
      font-weight: bold;
      padding: 1px 0;
      z-index: 1001;
      margin: 0;
      font-size: 18px;
    }

    marquee {
      padding: 0 20px;
    }

    /* Popup dan Overlay */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .popup-content {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: popupIn 0.3s ease;
    }

    @keyframes popupIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Black Overlay */
    #blackOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      z-index: 9999;
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      top: 30%;
      right: 20px;
      z-index: 99999;
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .col-12.col-md-4.d-flex.justify-content-end.align-items-center {
      position: relative;
      z-index: 1000;
      padding-right: 40px; /* Beri ruang untuk tombol pengaturan */
    }

    /* Tombol Pengaturan */
    /* Tombol Pengaturan - Versi Sederhana untuk STB */
    #settingsBtn {
      position: fixed;
      top: 22px;
      right: 10px;
      z-index: 1002;
      width: 35px;
      height: 35px;
      border-radius: 8px;
      color: white;
      display: block; /* Ganti dari flex */
      text-align: center;
      line-height: 35px; /* Center vertikal */
      cursor: pointer;
      padding: 0;
      font-size: 20px; /* Tampilkan icon */
    }

    /* Hilangkan semua pseudo elements dan CSS transform */
    #settingsBtn i {
      display: inline-block;
      transition: none; /* Nonaktifkan animasi untuk STB */
    }


    /* Untuk STB, lebih baik gunakan icon tetap tanpa animasi */
    @media (max-width: 768px) {
      #settingsBtn {
        width: 30px;
        height: 30px;
        line-height: 41px;
        font-size: 22px;
      }
    }

    

    /* Progress Bar untuk Lisensi */
    .progress {
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #005a31;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00816d;
    }

    /* Tombol Khusus */
    .btn-custom {
      background: var(--theme-primary) !important;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,90,49,0.3);
    }

    /* Card Image Preview */
    .image-preview {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .image-preview:hover {
      border-color: #005a31;
      background: #f8f9fa;
    }

    /* Untuk tampilan mobile/STB */
    @media (max-width: 768px) {
      .col-12.col-md-4.d-flex.justify-content-end.align-items-center {
        padding-right: 60px;
      }
      
      #clock {
        font-size: 35px;
        min-width: 120px;
        margin-right: 50px;
      }
      
      #settingsBtn {
        width: 45px;
        height: 45px;
        font-size: 22px;
      }
    }

    /* Pastikan header memiliki z-index yang tepat */
    .container-fluid.header {
      position: relative;
      z-index: 1001;
    }

    /* Sembunyikan tombol prev/next di semua carousel */
    .carousel-control-prev,
    .carousel-control-next {
        display: none !important;
    }

    /* Indicator untuk slide kanan */
    #mainCarousel .carousel-indicators {
        bottom: 10px;
    }

    /* Indicator untuk slide kiri */
    #leftCarousel .carousel-indicators {
        bottom: 10px;
    }

    /* Transisi untuk slide kiri (slide down) */
    #leftCarousel .carousel-inner .carousel-item {
        transition: transform 0.8s ease-in-out !important;
    }

    /* Transisi untuk slide kanan (opacity) */
    #mainCarousel .carousel-inner .carousel-item {
        transition: opacity 0.8s ease-in-out !important;
    }

    /* Hilangkan transition default Bootstrap */
    .carousel-item {
        transition: none !important;
    }

    /* Pastikan carousel items proper */
    #leftCarousel .carousel-item-next:not(.carousel-item-start),
    #leftCarousel .active.carousel-item-end {
        transform: translateY(100%) !important;
    }

    #leftCarousel .carousel-item-prev:not(.carousel-item-end),
    #leftCarousel .active.carousel-item-start {
        transform: translateY(-100%) !important;
    }

    #mainCarousel .carousel-item-next:not(.carousel-item-start),
    #mainCarousel .active.carousel-item-end {
        opacity: 0 !important;
    }

    #mainCarousel .carousel-item-prev:not(.carousel-item-end),
    #mainCarousel .active.carousel-item-start {
        opacity: 0 !important;
    }

    /* Style tombol plus/minus yang lebih baik */
    .btn-outline-primary, .btn-outline-success {
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 1.5rem !important;
        border-width: 2px !important;
    }

    /* Untuk tampilan STB */
    @media (max-width: 768px) {
        .btn-outline-primary, .btn-outline-success {
            width: 45px !important;
            height: 45px !important;
            font-size: 1.3rem !important;
        }
    }

    /* Modal pengaturan waktu sholat */
    #prayerSettingsModal .modal-body {
      padding: 1.5rem;
    }

    #prayerSettingsModal .btn-lg {
      padding: 15px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    #prayerSettingsModal .btn-group {
      margin-top: 10px;
    }

    #prayerSettingsModal .btn-group .btn {
      flex: 1;
      padding: 10px 0;
    }

    /* Tombol offset */
    .btn-outline-primary {
      border-color: #005a31;
      color: #005a31;
    }

    .btn-outline-primary:hover {
      background-color: #005a31;
      border-color: #005a31;
      color: white;
    }

    /* Popup Adzan dan Iqamah di sebelah kanan */
    .popup-overlay#popupAdzanOverlay,
    .popup-overlay#iqamahPopupOverlay {
      position: fixed;
      top: 42% !important;
      right: 20px !important;
      left: auto !important;
      width: auto !important;
      height: auto !important;
      max-width: 400px !important;
      transform: translateY(-50%) !important;
      display: none;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      border-radius: 15px;
      padding: 20px;
      animation: popupIn 0.3s ease !important;
    }

    /* Popup Peringatan di tengah */
    .popup-overlay#warningPopupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    /* Popup Imsak dan Syuruq di tengah */
    .popup-overlay#popupImsakOverlay,
    .popup-overlay#popupSyuruqOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Tombol close di overlay hitam */
    #closeBlackOverlay {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10006;
      font-size: 2rem;
      color: white;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #closeBlackOverlay:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ================= JAM TETAP DI ATAS BLACK OVERLAY ================= */
    #clock {
      position: fixed;              /* lepas dari header */
      top: 10px;                    /* posisi asli jam Anda */
      right: 50px;
      z-index: 10005;
      pointer-events: none;         /* tidak ganggu klik */
    }

    /* Untuk STB / mobile */
    @media (max-width: 768px) {
      #closeBlackOverlay {
        width: 30px;
        height: 30px;
        font-size: 20px;
      }
    }

    /* Tombol Screen OFF */
    #screenOffBtn {
      position: fixed;
      top: 22px;
      left: 10px;
      z-index: 1002;
      width: 35px;
      height: 35px;
      border-radius: 8px;
      color: white;
      text-align: center;
      line-height: 35px;
      cursor: pointer;
      font-size: 20px;
    }

    #screenOffBtn i {
      pointer-events: none;
    }

    /* Samakan ukuran dengan tombol gir */
    @media (max-width: 768px) {
      #screenOffBtn {
        width: 45px;
        height: 45px;
        line-height: 45px;
        font-size: 22px;
      }
    }

    #screenblack {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      z-index: 20000;
    }

    /* Tambahkan di bagian CSS */
    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        margin: 5px;
        cursor: pointer;
        border: 2px solid #ddd;
        transition: transform 0.2s;
    }

    .color-preview:hover {
        transform: scale(1.1);
        border-color: #666;
    }

    .color-preview.active {
        border-color: #000;
        transform: scale(1.05);
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }

    /* Splash Screen */
    #splashScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #0f0f0f;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        transition: opacity 0.5s ease;
    }

    #splashScreen.fade-out {
        opacity: 0;
        pointer-events: none;
    }

    .splash-logo {
        max-width: 300px;
        max-height: 200px;
        animation: pulse 2s infinite;
    }

    .splash-title {
        color: white;
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
    }

    .splash-subtitle {
        color: #cccccc;
        font-size: 16px;
        margin-bottom: 50px;
        text-align: center;
    }

    #enterBtn {
        position: absolute;
        bottom: 40px;
        right: 40px;
        background-color: #005a31;
        color: white;
        border: none;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 28px;
        box-shadow: 0 4px 15px rgba(0, 90, 49, 0.5);
        transition: all 0.3s ease;
    }

    #enterBtn:hover {
        background-color: #00816d;
    }

    #enterBtn i {
        margin-left: 5px; /* Untuk menggeser icon sedikit ke kanan */
    }

    /* CSS untuk form Running Text */
    .running-text-group {
        position: relative;
    }

    .delete-running-text-btn {
        position: absolute;
        right: 10px;
        top: 10px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #dc3545;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .delete-running-text-btn:hover {
        background-color: #c82333;
        transform: scale(1.1);
    }

    .form-label-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }


  </style>
</head>
<body>

<!-- Splash Screen -->
<div id="splashScreen">
    <img src="cover.png" alt="Logo Adzan TV" class="splash-logo" 
    onerror="this.onerror=null; this.src='cover.png'">
    <button id="enterBtn" onclick="enterMainApp()">
        <i class="bi bi-arrow-right"></i>
    </button>
</div>

<div id="screenblack"></div>


<!-- Black Overlay -->
<div id="blackOverlay">
  <button id="closeBlackOverlay" onclick="closeBlackOverlay()">‚úï</button>
</div>

<!-- Tombol Pengaturan -->
<div id="settingsBtn" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
  <i class="bi bi-gear-fill"></i>
</div>

<!-- Header -->
<div class="container-fluid header p-2">
  <div class="row align-items-center">
    <!-- Kiri: Tanggal dan Kalender Hijriyah -->
    <div class="col-12 col-md-4 text-start mb-2 mb-md-0">
      <div id="currentDate" style="font-size: 22px; font-weight: 600; margin-left: 40px;"></div>
      <!-- Tombol Screen OFF -->
      <div id="screenOffBtn">
        <i class="bi bi-power"></i>
      </div>
      <div id="hijriDate" style="font-size: 18px; color: #c6f6d5; margin-left: 40px;"></div>
    </div>
    <!-- Tengah: Logo & Nama Masjid serta Alamat -->
    <div class="col-12 col-md-4 d-flex align-items-center justify-content-center mb-2 mb-md-0">
        <img id="masjidLogo" src="logo.png" alt="Logo Masjid" class="img-fluid me-3" 
        style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"
        onerror="this.onerror=null; this.src='logo.png'">
      <div>
        <h2 id="masjidName" class="mb-1" style="font-weight: 800; color: white;">Mahallah TV</h2>
        <p id="masjidAddress" class="mb-0" style="font-size: 14px; color: #c6f6d5;">Dev: Rocky CHK </p>
      </div>
    </div>
    <!-- Kanan: Jam -->
    <div class="col-12 col-md-4 d-flex justify-content-end align-items-center">
      <div id="clock" class="text-white" style="font-size: 40px; font-weight: 700; min-width: 140px; text-align: center;">
        --:--:--
      </div>
    </div>
  </div>
</div>

<!-- Media Container -->
<div class="media-container">
  <!-- Frame Kiri (30%) -->
  <div class="media-left">
    <div id="leftCarousel" class="carousel slide h-100" data-bs-ride="carousel" data-bs-interval="10000">
      <div class="carousel-inner h-100" id="leftCarouselInner">
        <!-- Slide akan diisi JavaScript -->
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#leftCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#leftCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </div>

  <!-- Frame Kanan (70%) -->
  <div class="media-right">
    <div id="mainCarousel" class="carousel slide h-100" data-bs-ride="carousel" data-bs-interval="8000">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="2"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="3"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="4"></button>
      </div>
      <div class="carousel-inner h-100" id="mainCarouselInner">
        <!-- Gambar akan diisi JavaScript -->
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#mainCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#mainCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </div>
</div>

<!-- Jadwal Adzan -->
<div class="container-fluid p-0 adzan-table">
  <div class="table-responsive">
    <table class="table table-bordered text-center m-0">
      <thead>
        <tr id="jadwalHeader">
            <th id="thImsak">Imsak</th> <!-- TAMBAH INI -->
            <th id="thShubuh">Shubuh</th>
            <th id="thSyuruq">Syuruq</th>
            <th id="thDzuhur">Dzuhur</th>
            <th id="thAshar">Ashar</th>
            <th id="thMaghrib">Maghrib</th> <!-- TAMBAH INI -->
            <th id="thIsya">Isya</th> <!-- TAMBAH INI -->
        </tr>
      </thead>
      <tbody>
        <tr id="jadwalTimes">
          <td id="timeImsak">--:--</td>
          <td id="timeShubuh">--:--</td>
          <td id="timeSyuruq">--:--</td>
          <td id="timeDzuhur">--:--</td>
          <td id="timeAshar">--:--</td>
          <td id="timeMaghrib">--:--</td>
          <td id="timeIsya">--:--</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Running Text -->
<div class="marquee">
  <marquee behavior="scroll" direction="left" id="runningTextDisplay">
    Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba, Agar tidak mengganggu kekhusyukan Shalat || Allah Subhanahu Wa Ta'ala berfirman : "Sesungguhnya shalat itu mencegah dari (perbuatan) keji dan mungkar" (Q.S. Al-Ankabut:45).
  </marquee>
</div>

<!-- ==================== MODAL & POPUP ==================== -->

<!-- Popup Adzan -->
<div class="popup-overlay" id="popupAdzanOverlay">
  <div class="popup-content text-center">
    <h2 id="popupAdzanText" class="mb-4" style="color: #005a31;"></h2>
    <div id="popupCountdown" class="display-1 mb-4" style="font-weight: 800; color: #005a31;"></div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="popupProgress" class="progress-bar bg-success" style="width: 100%"></div>
    </div>
  </div>
</div>

<!-- Popup Iqamah -->
<div class="popup-overlay" id="iqamahPopupOverlay">
  <div class="popup-content text-center">
    <h2 id="iqamahText" class="mb-4" style="color: #005a31;"></h2>
    <div id="iqamahTimer" class="display-1 mb-4" style="font-weight: 800; color: #005a31;"></div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="iqamahProgress" class="progress-bar bg-warning" style="width: 100%"></div>
    </div>
  </div>
</div>

<!-- Popup Peringatan 15 detik sebelum iqamah -->
<div class="popup-overlay" id="warningPopupOverlay">
  <div class="popup-content text-center">
    <h2 id="warningText" class="mb-4" style="color: #dc3545;"></h2>
    <div id="warningTimer" class="display-1 mb-4" style="font-weight: 800; color: #dc3545;">15</div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="warningProgress" class="progress-bar bg-danger" style="width: 100%"></div>
    </div>
    <p class="lead mt-4" style="font-size: 1.5rem; font-weight: bold;">Mohon Nonaktifkan HP Anda segera!</p>
  </div>
</div>

<!-- Popup Imsak -->
<div class="popup-overlay" id="popupImsakOverlay">
  <div class="popup-content text-center">
    <h2 id="popupImsakText" class="mb-4" style="color: #005a31;">Waktu Imsak telah Tiba</h2>
    <div id="imsakBeepCounter" class="display-1 mb-4" style="font-weight: 800; color: #005a31;">15</div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="imsakProgress" class="progress-bar bg-info" style="width: 100%"></div>
    </div>
    <p class="lead mt-4" style="font-size: 1.5rem; font-weight: bold;">Segera hentikan makan dan minum!</p>
  </div>
</div>

<!-- Popup Syuruq -->
<div class="popup-overlay" id="popupSyuruqOverlay">
  <div class="popup-content text-center">
    <h2 id="popupSyuruqText" class="mb-4" style="color: #ff9800;">Waktu Syuruq telah Tiba</h2>
    <div id="syuruqBeepCounter" class="display-1 mb-4" style="font-weight: 800; color: #ff9800;">15</div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="syuruqProgress" class="progress-bar bg-warning" style="width: 100%"></div>
    </div>
    <p class="lead mt-4" style="font-size: 1.5rem; font-weight: bold;">Matahari telah terbit</p>
  </div>
</div>

<!-- Modal Pengaturan Waktu -->
<div class="modal fade" id="prayerSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="prayerNameLabel">Pengaturan Waktu Sholat</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-grid gap-2 mb-4">
          <button class="btn btn-success btn-lg" onclick="showCountdownForm('adzan')">
            <i class="bi bi-clock me-2"></i>Countdown Adzan
          </button>
          <button class="btn btn-warning btn-lg" onclick="showCountdownForm('iqamah')">
            <i class="bi bi-hourglass-split me-2"></i>Countdown Iqamah
          </button>
          <button class="btn btn-dark btn-lg" onclick="showCountdownForm('overlay')">
            <i class="bi bi-moon-stars me-2"></i>Durasi Overlay
          </button>
        </div>
        
        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <i class="bi bi-sliders me-2"></i>Offset Waktu Manual
          </div>
          <div class="card-body">
            <label class="form-label">Sesuaikan Waktu (menit)</label>
            <div class="btn-group w-100 mb-3">
              <button class="btn btn-outline-primary" onclick="adjustOffset(-5)">-5</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(-1)">-1</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(0)">Reset</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(+1)">+1</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(+5)">+5</button>
            </div>
            <div class="text-center">
              <span id="currentOffset" class="badge bg-primary">Offset: 0 menit</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Form Countdown -->
<div class="modal fade" id="countdownFormModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" id="countdownModalHeader">
        <h5 class="modal-title" id="countdownTitle">Pengaturan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="countdownFormBody">
        <!-- Form akan diisi JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- ==================== OFFCANVAS MENU ==================== -->

<!-- Main Offcanvas Menu -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="mainOffcanvasMenu" aria-labelledby="mainOffcanvasMenuLabel">
  <div class="offcanvas-header bg-primary text-white">
    <h4 class="offcanvas-title" id="mainOffcanvasMenuLabel"><i class="bi bi-gear-fill me-2"></i>Pengaturan</h4>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="d-grid gap-2">
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDataMasjid">
        <i class="bi bi-building me-2"></i>Data Masjid
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRunningText">
        <i class="bi bi-textarea-t me-2"></i>Running Text
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasPesanTeks">
        <i class="bi bi-chat-text me-2"></i>Pesan Teks (Slide 1)
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasUploadGambar">
        <i class="bi bi-images me-2"></i>Upload Gambar
      </button>
      <button class="btn btn-success btn-lg" onclick="showSliderSettingsForm()">
        <i class="bi bi-sliders me-2"></i>Durasi Slider
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasColorSettings">
        <i class="bi bi-palette me-2"></i>Warna Tema
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasTutorial">
        <i class="bi bi-book me-2"></i>Tutorial
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasInfoAplikasi">
        <i class="bi bi-info-circle me-2"></i>Info Aplikasi
      </button>
    </div>
  </div>
</div>

<!-- Offcanvas Data Masjid -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasDataMasjid">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üìç Data Masjid</h5>
  </div>
  <div class="offcanvas-body">
    <form id="masjidDataForm">
      <div class="mb-3">
        <label class="form-label">Logo Masjid</label>
        <input type="file" class="form-control" id="logoInput" accept="image/*">
        <small class="text-muted">Upload logo (PNG/JPG, maks 500KB)</small>
        <div id="logoPreview" class="mt-2 text-center">
            <img id="logoPreviewImg" src="logo.png" style="max-width: 200px; max-height: 200px;" 
            class="img-thumbnail" onerror="this.onerror=null; this.src='logo.png'">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Nama Masjid</label>
        <input type="text" class="form-control" id="namaMasjidInput" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Alamat Masjid</label>
        <textarea class="form-control" id="alamatMasjidInput" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary w-100 mb-2">
        <i class="bi bi-save me-2"></i>Simpan Data
      </button>
    </form>
    <button class="btn btn-danger w-100" id="resetMasjidData">
      <i class="bi bi-arrow-clockwise me-2"></i>Reset ke Default
    </button>
  </div>
</div>

<!-- Offcanvas Running Text -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRunningText">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üìú Running Text (Maks. 3)</h5>
  </div>
  <div class="offcanvas-body">
    <form id="runningTextForm">
      <div id="runningTextInputs">
        <!-- Running Text 1 (wajib) -->
        <div class="mb-3" id="runningTextGroup1">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label fw-bold">Running Text 1 <span class="text-danger">*</span></label>
            <!-- Tombol hapus akan muncul untuk RT2 dan RT3 saja -->
          </div>
          <input type="text" class="form-control" id="runningText1" required placeholder="Masukkan running text pertama">
        </div>
      </div>
      
      <!-- Tombol Tambah Running Text -->
      <button type="button" class="btn btn-info w-100 mb-3" id="addRunningTextBtn">
        <i class="bi bi-plus-circle me-2"></i>Tambah Running Text
      </button>
      
      <!-- Informasi -->
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        Running text akan digabung dengan pemisah " || " dan ditampilkan berurutan
      </div>
      
      <!-- Tombol Simpan -->
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-save me-2"></i>Simpan Running Text
      </button>
    </form>
  </div>
</div>

<!-- Offcanvas Pesan Teks -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasPesanTeks">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üí¨ Pesan Teks Slide 1</h5>
  </div>
  <div class="offcanvas-body">
    <form id="pesanTeksForm">
      <div class="mb-3">
        <label class="form-label">Pesan untuk Slide 1</label>
        <textarea class="form-control" id="pesanTeksInput" rows="6" maxlength="300"></textarea>
        <div class="form-text">
          <span id="charCount">0</span>/300 karakter
        </div>
      </div>
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-save me-2"></i>Simpan Pesan
      </button>
    </form>
    <div class="alert alert-info mt-3">
      <i class="bi bi-info-circle me-2"></i>
      Pesan ini akan ditampilkan di Slide 1 carousel kiri
    </div>
  </div>
</div>

<!-- Offcanvas Upload Gambar -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasUploadGambar">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üñºÔ∏è Upload Gambar (Maks. 5)</h5>
  </div>
  <div class="offcanvas-body">
    <div class="mb-3">
      <label class="form-label">Pilih Gambar</label>
      <input type="file" class="form-control" id="imageUpload" accept="image/jpeg,image/png" multiple>
      <small class="text-muted">Pilih 1-5 gambar (JPG/PNG, maks 1MB per gambar)</small>
    </div>
    
    <div id="uploadProgress" class="progress mb-3" style="display: none;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
    </div>
    
    <button class="btn btn-success w-100 mb-3" onclick="uploadImages()">
      <i class="bi bi-cloud-upload me-2"></i>Upload Gambar
    </button>
    
    <div id="uploadedImagesList">
      <h6>Gambar Terupload:</h6>
      <div id="imagesContainer" class="row">
        <!-- Gambar akan ditampilkan di sini -->
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Pengaturan Warna -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasColorSettings">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title"><i class="bi bi-palette me-2"></i>Warna Tema</h5>
  </div>
  <div class="offcanvas-body">
    <div class="mb-4">
      <h6>Pilih Warna Tema:</h6>
      <div class="row g-2">
        <div class="col-4">
          <button class="btn w-100 h-100 p-3" style="background-color: #005a31; color: white;" onclick="changeThemeColor('#005a31')">
            Hijau
          </button>
        </div>
        <div class="col-4">
          <button class="btn w-100 h-100 p-3" style="background-color: #213d68; color: white;" onclick="changeThemeColor('#213d68')">
            Biru
          </button>
        </div>
        <div class="col-4">
          <button class="btn w-100 h-100 p-3" style="background-color: #57252a; color: white;" onclick="changeThemeColor('#57252a')">
            Merah
          </button>
        </div>
        <div class="col-4">
          <button class="btn w-100 h-100 p-3" style="background-color: #372952; color: white;" onclick="changeThemeColor('#372952')">
            Ungu
          </button>
        </div>
        <div class="col-4">
          <button class="btn w-100 h-100 p-3" style="background-color: #663711; color: white;" onclick="changeThemeColor('#663711')">
            Cokelat
          </button>
        </div>
        <div class="col-4">
          <button class="btn w-100 h-100 p-3" style="background-color: #212529; color: white;" onclick="changeThemeColor('#212529')">
            Hitam
          </button>
        </div>
      </div>
    </div>
    
    <div class="mb-4">
      <h6>Warna Kustom:</h6>
      <div class="input-group mb-2">
        <input type="color" class="form-control form-control-color" id="customColorPicker" value="#005a31" title="Pilih warna kustom">
        <button class="btn btn-primary" onclick="applyCustomColor()">
          <i class="bi bi-check-lg"></i>
        </button>
      </div>
      <small class="text-muted">Pilih warna atau gunakan warna kustom</small>
    </div>
    
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      Warna akan diterapkan ke header, tabel adzan, dan elemen lainnya
    </div>
    
    <button class="btn btn-danger w-100 mt-3" onclick="resetThemeColor()">
      <i class="bi bi-arrow-clockwise me-2"></i>Reset ke Warna Default
    </button>
  </div>
</div>

<!-- Offcanvas Tutorial -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasTutorial">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üìñ Tutorial Penggunaan</h5>
  </div>
  <div class="offcanvas-body">
    <div class="accordion" id="tutorialAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial1">
            <i class="bi bi-clock me-2"></i>1. Pengaturan Waktu Sholat
          </button>
        </h2>
        <div id="tutorial1" class="accordion-collapse collapse show">
          <div class="accordion-body">
            <p>Klik pada waktu sholat di tabel untuk membuka pengaturan:</p>
            <ul>
              <li><strong>Countdown Adzan</strong>: Atur waktu countdown sebelum adzan</li>
              <li><strong>Countdown Iqamah</strong>: Atur waktu menunggu iqamah</li>
              <li><strong>Durasi Overlay</strong>: Atur berapa lama overlay hitam ditampilkan</li>
              <li><strong>Offset Waktu</strong>: Sesuaikan +/- menit dari waktu otomatis</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial2">
            <i class="bi bi-images me-2"></i>2. Upload Gambar
          </button>
        </h2>
        <div id="tutorial2" class="accordion-collapse collapse">
          <div class="accordion-body">
            <p>Maksimal 5 gambar untuk carousel kanan:</p>
            <ol>
              <li>Buka menu <strong>Upload Gambar</strong></li>
              <li>Pilih gambar dari perangkat Anda</li>
              <li>Klik tombol Upload</li>
              <li>Gambar akan muncul di carousel kanan</li>
            </ol>
            <p class="text-muted">Catatan: Gambar disimpan di perangkat Anda (offline)</p>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial3">
            <i class="bi bi-chat-text me-2"></i>3. Pesan Teks dan Running Text
          </button>
        </h2>
        <div id="tutorial3" class="accordion-collapse collapse">
          <div class="accordion-body">
            <p><strong>Pesan Teks:</strong> Untuk Slide 1 carousel kiri</p>
            <p><strong>Running Text:</strong> Untuk teks berjalan di bagian bawah layar</p>
            <p>Anda dapat menambahkan hingga 3 running text yang akan digabung</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Info Aplikasi -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasInfoAplikasi">
    <div class="offcanvas-header bg-primary text-white">
      <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
        <i class="bi bi-arrow-left"></i>
      </button>
      <h5 class="offcanvas-title">‚ÑπÔ∏è Info Aplikasi</h5>
    </div>
    <div class="offcanvas-body">
      <div class="text-center mb-4">
        <div class="display-1 mb-2">üïå</div>
        <h3>Adzan Mahallah TV</h3>
        <p class="text-muted">v2.0 - Khusus STB Indihome HG680-P</p>
      </div>      
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>Kontak Developer</h6>
        </div>
        <div class="card-body">
          <p><i class="bi bi-telephone me-2"></i><strong>Telepon:</strong> 089609745090</p>
          <p><i class="bi bi-envelope me-2"></i><strong>Email:</strong> support@adzanapp.com</p>
          <p><i class="bi bi-globe me-2"></i><strong>Website:</strong> www.adzanapp.com</p>
        </div>
      </div>
    </div>
  </div>

<!-- ==================== AUDIO ELEMENTS ==================== -->
<audio id="audioShalawat" src="shalawat.mp3" loop preload="none"></audio>
<audio id="audioAdzan" src="adzan.mp3" preload="none"></audio>
<audio id="audioBeep" src="beep.mp3" preload="none"></audio>
<audio id="audioRooster" src="rooster.mp3" preload="none"></audio>

<!-- ==================== SCRIPTS ==================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

// Deteksi kemampuan ES5
function checkES5Compatibility() {
    var compatibility = {
        var: true,
        function: true,
        forLoop: true,
        getElementById: !!document.getElementById,
        addEventListener: !!window.addEventListener,
        localStorage: !!window.localStorage,
        JSON: !!window.JSON
    };
    
    console.log('ES5 Compatibility Check:');
    for (var key in compatibility) {
        if (compatibility.hasOwnProperty(key)) {
            console.log(key + ': ' + (compatibility[key] ? '‚úÖ' : '‚ùå'));
        }
    }
    
    // Jika ada yang tidak support, beri warning
    if (!compatibility.localStorage) {
        console.warn('LocalStorage tidak didukung! Pengaturan tidak akan tersimpan.');
    }
}

// Panggil saat aplikasi dimulai
checkES5Compatibility();


// ==================== VARIABLES GLOBAL ====================
var adzanSchedule = {};
var currentPrayer = '';
var isSTB = false;

// Data sederhana untuk STB
var settings = {
    masjidName: 'Mahallah TV',
    masjidAddress: 'Dev: Rocky CHK',
    runningText: 'Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba, Agar tidak mengganggu kekhusyukan Shalat',
    customMessage: 'Selamat datang di Masjid Mahallah TV\\n\\nMari bersama menjaga kebersihan dan ketertiban masjid untuk kenyamanan beribadah kita semua.',
    uploadedImages: [],
    themeColor: '#005a31', // Tambah properti tema
};

// ==================== TAMBAHKAN VARIABEL BARU INI ====================
var adzanCountdownDurations = {};
var iqamahCountdownDurations = {};
var overlayBlackDurations = {};
var prayerOffsets = {};
var originalPrayerTimes = {}

var warningState = {
  active: false,
  interval: null
};

var imsakState = {
  active: false,
  beepCount: 0,
  interval: null
};

var syuruqState = {
  active: false,
  beepCount: 0,
  interval: null
};

var blackOverlayInterval = null;

// ‚úÖ DEFAULT GAMBAR CAROUSEL KANAN
var defaultMainImages = [
  'default1.jpg',
  'default2.jpg',
  'default3.jpg',
  'default4.jpg',
  'default5.jpg'
];

var ayatHaditsIndex = 0; // Indeks saat ini
var ayatHaditsHistory = []; // Menyimpan indeks yang sudah ditampilkan

// ==================== AKHIR TAMBAHAN ====================

// ==================== FUNGSI TANGGAL & WAKTU ====================
function initClock() {
    updateClock();
    setInterval(updateClock, 1000);
}

function updateClock() {
    try {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        var seconds = now.getSeconds();
        
        document.getElementById('clock').textContent = 
            (hours < 10 ? '0' : '') + hours + ':' + 
            (minutes < 10 ? '0' : '') + minutes + ':' + 
            (seconds < 10 ? '0' : '') + seconds;
    } catch (e) {
        console.log('Error updateClock:', e);
    }
}

function initDate() {
    updateDate();
    setInterval(updateDate, 300000);
}

function updateDate() {
    try {
        var now = new Date();
        var days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        var months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        var dateStr = days[now.getDay()] + ', ' + now.getDate() + ' ' + 
                     months[now.getMonth()] + ' ' + now.getFullYear();
        
        document.getElementById('currentDate').textContent = dateStr;
    } catch (e) {
        console.log('Error updateDate:', e);
    }
}

function initHijri() {
    updateHijri();
    setInterval(updateHijri, 300000);
}

function updateHijri() {
    try {
        var now = new Date();
        var hijriObj = HijriCalendar.get(now);

        // üî¥ INI YANG WAJIB ADA
        window.hijriDateString = hijriObj.text;
        window.currentHijriDate = hijriObj;

        document.getElementById('hijriDate').textContent = hijriObj.text;


    } catch (e) {
        window.hijriDateString = "";
        document.getElementById('hijriDate').textContent = "-- -- ---- H";
    }
}




// ==================== JADWAL ADZAN ====================
function initPrayerTimes() {
    // Koordinat Bone Bolango (sesuai permintaan)
    var lat = 0.6106944;   // Latitude
    var lng = 123.0846244; // Longitude
    
    // Set metode perhitungan (contoh: Kemenag)
    prayTimes.setMethod('Kemenag');
    
    // Hitung waktu sholat untuk hari ini
    var now = new Date();
    var times = prayTimes.getTimes(
        now,
        [lat, lng],
        8, // WITA (UTC+8)
        0  // No DST
    );
    
    // Format waktu sesuai kebutuhan Anda
    adzanSchedule = {
        imsak: formatPrayTime(times.imsak),
        shubuh: formatPrayTime(times.fajr),
        syuruq: formatPrayTime(times.sunrise),
        dzuhur: formatPrayTime(times.dhuhr),
        ashar: formatPrayTime(times.asr),
        maghrib: formatPrayTime(times.maghrib),
        isya: formatPrayTime(times.isha)
    };
    
    // Simpan waktu asli
    for (var prayer in adzanSchedule) {
        originalPrayerTimes[prayer] = adzanSchedule[prayer];
    }
    
    // Update tampilan
    updatePrayerTimesUI();
    
    // Cek waktu sholat setiap detik
    setInterval(checkPrayerTimes, 5000);
    
    // Debug: tampilkan waktu yang dihitung
    console.log('Waktu Sholat (PrayTimes):', adzanSchedule);
}

function formatPrayTime(timeStr) {
    if (!timeStr || timeStr.includes('-----')) {
        return '--:--';
    }
    
    // Convert dari format "HH:MM" atau "HH:MM (24h)"
    var time = timeStr.split(' ')[0]; // Ambil bagian waktu saja
    var parts = time.split(':');
    
    if (parts.length === 2) {
        return parts[0].padStart(2, '0') + ':' + parts[1].padStart(2, '0');
    }
    
    return '--:--';
}

/*
function calculateOfflinePrayerTimes(lat, lng) {
    // Algoritma sederhana untuk STB
    var now = new Date();
    var dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
    
    // Deklinasi matahari sederhana
    var declination = 23.45 * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81));
    
    // Equation of time sederhana
    var B = (2 * Math.PI / 365) * (dayOfYear - 81);
    var EoT = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
    
    // Timezone WITA (UTC+8)
    var timezone = 8;
    
    // Perhitungan waktu
    var solarNoon = 12 + (4 * (lng - (timezone * 15)) - EoT) / 60;
    
    // Hour angle untuk sunrise/sunset
    var latRad = lat * Math.PI / 180;
    var decRad = declination * Math.PI / 180;
    var ha = Math.acos(-Math.tan(latRad) * Math.tan(decRad)) * 180 / Math.PI / 15;
    
    // Waktu-waktu sholat dengan offset lokal
    var times = {
        imsak: addMinutes(formatTime(solarNoon - ha - 1.2), -2),
        shubuh: addMinutes(formatTime(solarNoon - ha - 0.7), -2),
        syuruq: formatTime(solarNoon - ha + 0.2),
        dzuhur: addMinutes(formatTime(solarNoon + 0.1), +1),
        ashar: addMinutes(formatTime(solarNoon + ha * 0.8), +2),
        maghrib: formatTime(solarNoon + ha - 0.1),
        isya: addMinutes(formatTime(solarNoon + ha + 0.5), +3)
    };
    
    return times;
}
    */

function formatTime(decimalHours) {
    var hour = Math.floor(decimalHours);
    var minute = Math.round((decimalHours - hour) * 60);
    
    if (minute >= 60) {
        hour++;
        minute -= 60;
    }
    if (hour >= 24) hour -= 24;
    if (hour < 0) hour += 24;
    
    return (hour < 10 ? '0' : '') + hour + ':' + (minute < 10 ? '0' : '') + minute;
}

function addMinutes(timeStr, minutes) {
    if (!timeStr || timeStr === '--:--') return '--:--';
    
    var parts = timeStr.split(':');
    var hour = parseInt(parts[0]);
    var minute = parseInt(parts[1]) + minutes;
    
    while (minute >= 60) {
        hour++;
        minute -= 60;
    }
    while (minute < 0) {
        hour--;
        minute += 60;
    }
    
    if (hour >= 24) hour -= 24;
    if (hour < 0) hour += 24;
    
    return (hour < 10 ? '0' : '') + hour + ':' + (minute < 10 ? '0' : '') + minute;
}

function updatePrayerTimesUI() {
    var elements = {
        imsak: 'timeImsak',
        shubuh: 'timeShubuh',
        syuruq: 'timeSyuruq',
        dzuhur: 'timeDzuhur',
        ashar: 'timeAshar',
        maghrib: 'timeMaghrib',
        isya: 'timeIsya'
    };
    
    for (var prayer in elements) {
        var element = document.getElementById(elements[prayer]);
        if (element && adzanSchedule[prayer]) {
            element.textContent = adzanSchedule[prayer];
        }
    }
    
    // Highlight sholat berikutnya
    highlightNextPrayer();
}

function highlightNextPrayer() {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    var prayers = ['imsak', 'shubuh', 'syuruq', 'dzuhur', 'ashar', 'maghrib', 'isya'];
    for (var i = 0; i < prayers.length; i++) {
        var p = prayers[i];
        var el = document.getElementById('time' + p.charAt(0).toUpperCase() + p.slice(1));
        if (el) el.classList.remove('active');
    }

    // Reset semua highlight
    prayers.forEach(p => {
        const el = document.getElementById('time' + p.charAt(0).toUpperCase() + p.slice(1));
        if (el) el.classList.remove('active');
    });
    
    // Ambil waktu Isya terlebih dahulu (karena siklus setelah Isya adalah Imsak)
    const isyaStr = adzanSchedule.isya;
    if (isyaStr && isyaStr !== '--:--') {
        const [ih, im] = isyaStr.split(':').map(Number);
        const isyaMinutes = ih * 60 + im;
        
        // ‚úÖ SETELAH ISYA ‚Üí IMSAK (untuk siklus dini hari)
        if (currentMinutes >= isyaMinutes) {
            const imsakCell = document.getElementById('timeImsak');
            if (imsakCell) imsakCell.classList.add('active');
            return;
        }
    }
    
    // Untuk Imsak dan Syuruq, kita perlu handle khusus
    // Urutan: Imsak ‚Üí Shubuh ‚Üí Syuruq ‚Üí Dzuhur ‚Üí Ashar ‚Üí Maghrib ‚Üí Isya
    
    for (let i = 0; i < prayers.length; i++) {
        const p = prayers[i];
        const timeStr = adzanSchedule[p];
        
        if (!timeStr || timeStr === '--:--') continue;
        
        const [h, m] = timeStr.split(':').map(Number);
        const prayerMinutes = h * 60 + m;
        
        // Jika waktu sholat ini lebih besar dari waktu sekarang
        if (prayerMinutes > currentMinutes) {
            const el = document.getElementById('time' + p.charAt(0).toUpperCase() + p.slice(1));
            if (el) el.classList.add('active');
            return;
        }
    }
    
    // Jika semua waktu sudah lewat, highlight Imsak untuk hari berikutnya
    const imsakCell = document.getElementById('timeImsak');
    if (imsakCell) imsakCell.classList.add('active');
}

// Panggil fungsi ini setiap menit untuk update highlight
setInterval(highlightNextPrayer, 60000);



// ==================== VARIABEL COUNTDOWN ====================
var countdownState = {
  active: false,
  type: null, // 'adzan' atau 'iqamah'
  prayer: null,
  remaining: 0,
  interval: null
};

var warningState = {
  active: false,
  interval: null
};

// ==================== FUNGSI COUNTDOWN ADZAN ====================
function showPopupAdzan(prayer) {
    // ================= KHUSUS JUMAT =================
    if (isJumat() && prayer === 'dzuhur') {
        countdownState.active = true;
        countdownState.type = 'adzan';
        countdownState.prayer = prayer;
        const durationMinutes = adzanCountdownDurations[prayer] || 15;
        countdownState.remaining = durationMinutes * 60;
        document.getElementById('popupAdzanText').innerHTML = `Waktu Adzan Jumat<br>`;
        document.getElementById('popupAdzanOverlay').style.display = 'block';
        
        // üîá PASTIKAN SHALAWAT MATI
        const shalawat = document.getElementById('audioShalawat');
        if (shalawat) {
            shalawat.pause();
            shalawat.currentTime = 0;
        }
        
        startAdzanCountdown();
        return;
    }
    
    // Kode asli untuk hari lain
    if (countdownState.active) return;
    
    const prayerNames = {
        shubuh: 'Shubuh',
        dzuhur: 'Dzuhur',
        ashar: 'Ashar',
        maghrib: 'Maghrib',
        isya: 'Isya'
    };
    
    if (!prayerNames[prayer]) return;
    
    // Set state
    countdownState.active = true;
    countdownState.type = 'adzan';
    countdownState.prayer = prayer;
    
    // Durasi countdown adzan (dalam detik)
    const durationMinutes = adzanCountdownDurations[prayer] || 10;
    countdownState.remaining = durationMinutes * 60;
    
    // Update popup text
    document.getElementById('popupAdzanText').textContent = `Waktu Adzan ${prayerNames[prayer]}`;
    
    // Tampilkan popup di sebelah kanan
    const popup = document.getElementById('popupAdzanOverlay');
    popup.style.display = 'block';
    popup.style.right = '20px';
    popup.style.left = 'auto';
    popup.style.transform = 'translateY(-50%)';
    popup.style.top = '50%';
    
    // Mainkan audio shalawat (loop)
    const audioShalawat = document.getElementById('audioShalawat');
    if (audioShalawat) {
        audioShalawat.currentTime = 0;
        audioShalawat.loop = true;
        audioShalawat.play().catch(e => console.log('Error playing shalawat:', e));
    }
    
    // Mulai countdown
    startAdzanCountdown();
}


function startAdzanCountdown() {
  if (countdownState.interval) {
    clearInterval(countdownState.interval);
  }
  
  const countdownElement = document.getElementById('popupCountdown');
  const progressElement = document.getElementById('popupProgress');
  const totalDuration = countdownState.remaining;
  
  countdownState.interval = setInterval(() => {
    const minutes = Math.floor(countdownState.remaining / 60);
    const seconds = countdownState.remaining % 60;
    
    countdownElement.textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = (countdownState.remaining / totalDuration) * 100;
    progressElement.style.width = `${progress}%`;
    
    if (countdownState.remaining <= 0) {
      clearInterval(countdownState.interval);
      countdownState.interval = null;
      
      // Countdown adzan selesai
      endAdzanCountdown();
    }
    
    countdownState.remaining--;
  }, 1000);
}

function endAdzanCountdown() {
    // HENTIKAN AUDIO SHALAWAT
    const audioShalawat = document.getElementById('audioShalawat');
    if (audioShalawat) {
        audioShalawat.pause();
        audioShalawat.currentTime = 0;
    }
    
    // Tutup popup
    document.getElementById('popupAdzanOverlay').style.display = 'none';
    
    // ================= KHUSUS JUMAT =================
    if (isJumat() && countdownState.prayer === 'dzuhur') {
        // üîá MATIKAN SEMUA AUDIO (TERMASUK ADZAN)
        stopAllAudio();
        // ‚¨õ LANGSUNG AKTIFKAN OVERLAY JUMAT
        showJumatOverlay();
        // üî¥ CLEANUP MEMORY
        countdownState.active = false;
        countdownState.type = null;
        countdownState.prayer = null;
        countdownState.remaining = 0;
        // Clear DOM references
        document.getElementById('popupCountdown').textContent = '';
        document.getElementById('popupProgress').style.width = '0%';
        return; // ‚õî STOP, JANGAN KE IQAMAH
    }
    
    // ================= HARI BIASA =================
    const audioAdzan = document.getElementById('audioAdzan');
    if (audioAdzan) {
        audioAdzan.currentTime = 0;
        audioAdzan.play();
    }
    
    setTimeout(() => {
        showPopupIqamah(countdownState.prayer);
    }, 1000);
}


// ==================== FUNGSI KHUSUS UNTUK HARI JUMAT ====================
// Fungsi untuk mengecek apakah hari ini Jumat
function isJumat() {
    var now = new Date();
    return now.getDay() === 5; // 0 = Minggu, 5 = Jumat
}

// Fungsi untuk mengupdate teks Dzuhur menjadi Jumat
// Fungsi untuk mengupdate teks Dzuhur menjadi Jumat
function updateJumatDisplay() {
    if (isJumat()) {
        // Ganti teks "Dzuhur" menjadi "Jumat" di header
        var thDzuhur = document.getElementById('thDzuhur');
        if (thDzuhur) {
            thDzuhur.textContent = 'Jumat';
        }
        
        // HAPUS KODE BADGE di samping kanan - Hanya ganti highlight warna
        var timeDzuhurCell = document.getElementById('timeDzuhur');
        if (timeDzuhurCell) {
            // Hapus badge lama jika ada
            var existingBadge = timeDzuhurCell.querySelector('.jumat-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
        }
    } else {
        // Kembalikan teks "Dzuhur" jika bukan Jumat
        var thDzuhur = document.getElementById('thDzuhur');
        if (thDzuhur) {
            thDzuhur.textContent = 'Dzuhur';
        }
    }
}

// Fungsi khusus untuk overlay Jumat
function showJumatOverlay() {
    
    stopAllAudio();
    
    document.getElementById('blackOverlay').style.display = 'block';
    document.getElementById('closeBlackOverlay').style.display = 'block';
    
    // Sembunyikan elemen yang perlu disembunyikan
    ['.media-container', '.adzan-table', '.marquee'].forEach(sel => {
        const el = document.querySelector(sel);
        if (el) {
            el.style.visibility = 'hidden';
            el.style.opacity = '0';
        }
    });
    
    // Tetap tampilkan header dan jam
    document.querySelector('.header').style.visibility = 'visible';
    document.querySelector('.header').style.opacity = '1';
    
    // Jam tetap di atas
    document.getElementById('clock').style.visibility = 'visible';
    document.getElementById('clock').style.opacity = '1';
    
    // Durasi overlay Jumat
    const durasiJumat = overlayBlackDurations['dzuhur'] || 90; // Default 90 menit untuk Jumat
    setTimeout(closeBlackOverlay, durasiJumat * 60 * 1000);
    
}

// Tambahkan CSS untuk badge Jumat
var jumatStyle = document.createElement('style');
jumatStyle.textContent = `
    .jumat-badge {
        display: inline-block;
        margin-left: 5px;
    }
    
    /* Highlight khusus untuk waktu Jumat */
    #timeDzuhur.active {
        background: #005a31 !important;
        color: white !important;
    }

    /* Tambahan untuk STB */
    @media (max-width: 768px) {
        .jumat-badge .badge {
            font-size: 12px !important;
            padding: 1px 5px !important;
        }
        
        #thDzuhur {
            font-size: 18px !important;
        }
    }
`;
document.head.appendChild(jumatStyle);



// ==================== FUNGSI COUNTDOWN IQAMAH ====================
function showPopupIqamah(prayer) {
  
  const prayerNames = {
    shubuh: 'Shubuh',
    dzuhur: 'Dzuhur',
    ashar: 'Ashar',
    maghrib: 'Maghrib',
    isya: 'Isya'
  };
  
  if (!prayerNames[prayer]) return;
  
  // Update state
  countdownState.type = 'iqamah';
  countdownState.prayer = prayer;
  
  // Durasi countdown iqamah (dalam detik)
  const durationMinutes = iqamahCountdownDurations[prayer] || 25;
  countdownState.remaining = durationMinutes * 60;
  
  // Update popup text
  document.getElementById('iqamahText').textContent = 
    `Waktu Iqamah ${prayerNames[prayer]}`;
  
  // Tampilkan popup di sebelah kanan
  const popup = document.getElementById('iqamahPopupOverlay');
  popup.style.display = 'block';
  popup.style.right = '20px';
  popup.style.left = 'auto';
  popup.style.transform = 'translateY(-50%)';
  popup.style.top = '50%';
  
  // Mulai countdown iqamah
  startIqamahCountdown();
}

function startIqamahCountdown() {
  if (countdownState.interval) {
    clearInterval(countdownState.interval);
  }
  
  const countdownElement = document.getElementById('iqamahTimer');
  const progressElement = document.getElementById('iqamahProgress');
  const totalDuration = countdownState.remaining;
  
  countdownState.interval = setInterval(() => {
    const minutes = Math.floor(countdownState.remaining / 60);
    const seconds = countdownState.remaining % 60;
    
    countdownElement.textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = (countdownState.remaining / totalDuration) * 100;
    progressElement.style.width = `${progress}%`;
    
    // Cek jika 15 detik tersisa
    if (countdownState.remaining === 15) {
      showWarningPopup();
    }
    
    if (countdownState.remaining <= 0) {
      clearInterval(countdownState.interval);
      countdownState.interval = null;
      countdownState.active = false;
      
      // Countdown iqamah selesai
      endIqamahCountdown();
    }
    
    countdownState.remaining--;
  }, 1000);
}

function showWarningPopup() {
  
  // Tutup popup iqamah
  document.getElementById('iqamahPopupOverlay').style.display = 'none';
  
  // Tampilkan popup peringatan di tengah
  const popup = document.getElementById('warningPopupOverlay');
  popup.style.display = 'flex';
  popup.style.justifyContent = 'center';
  popup.style.alignItems = 'center';
  
  // Update text
  const prayerNames = {
    shubuh: 'Shubuh',
    dzuhur: 'Dzuhur',
    ashar: 'Ashar',
    maghrib: 'Maghrib',
    isya: 'Isya'
  };
  
  const prayerName = prayerNames[countdownState.prayer] || 'Shalat';
  document.getElementById('warningText').innerHTML = 
    `Shalat ${prayerName} akan dimulai`;
  
  // Mainkan audio beep (loop)
  const audioBeep = document.getElementById('audioBeep');
  if (audioBeep) {
    audioBeep.currentTime = 0;
    audioBeep.loop = true;
    audioBeep.play().catch(e => console.log('Error playing beep:', e));
  }
  
  // Mulai countdown peringatan (15 detik)
  let warningTime = 15;
  const warningElement = document.getElementById('warningTimer');
  const warningProgress = document.getElementById('warningProgress');
  
  if (warningState.interval) {
    clearInterval(warningState.interval);
  }
  
  warningState.active = true;
  warningState.interval = setInterval(() => {
    warningElement.textContent = 
      `${warningTime.toString().padStart(2, '0')}`;
    
    const progress = (warningTime / 15) * 100;
    warningProgress.style.width = `${progress}%`;
    
    if (warningTime <= 0) {
      clearInterval(warningState.interval);
      warningState.interval = null;
      warningState.active = false;
      
      // Tutup popup peringatan
      popup.style.display = 'none';
      
      // Hentikan audio beep
      if (audioBeep) {
        audioBeep.pause();
        audioBeep.currentTime = 0;
      }
    }
    
    warningTime--;
  }, 1000);
}

function endIqamahCountdown() {
  stopAllAudio();

  document.getElementById('blackOverlay').style.display = 'block';
  document.getElementById('closeBlackOverlay').style.display = 'block';

  ['.media-container', '.adzan-table', '.marquee'].forEach(sel => {
    const el = document.querySelector(sel);
    if (el) {
      el.style.visibility = 'hidden';
      el.style.opacity = '0';
    }
  });
 
  const durasi = overlayBlackDurations[countdownState.prayer] || 15;
  setTimeout(closeBlackOverlay, durasi * 60 * 1000);

      // üî¥ CLEANUP MEMORY
    countdownState.active = false;
    countdownState.type = null;
    countdownState.prayer = null;
    countdownState.remaining = 0;

}

function closeBlackOverlay() {
  document.getElementById('blackOverlay').style.display = 'none';
  document.getElementById('closeBlackOverlay').style.display = 'none';

  ['.media-container', '.adzan-table', '.marquee'].forEach(sel => {
    const el = document.querySelector(sel);
    if (el) {
      el.style.visibility = 'visible';
      el.style.opacity = '1';
    }
  });

  // ‚úÖ RELOAD HALAMAN SETELAH OVERLAY BERAKHIR
    setTimeout(() => {
        softResetApp();
    }, 500); // delay kecil biar STB stabil
}




// ==================== UPDATE checkPrayerTimes ====================
// ==================== CEK WAKTU SHOLAT (DENGAN ROOSTER UNTUK IMSAK) ====================
function checkPrayerTimes() {
    const now = new Date();
    const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
    
    const prayers = ['shubuh', 'dzuhur', 'ashar', 'maghrib', 'isya'];
    
    prayers.forEach(prayer => {
        const timeStr = adzanSchedule[prayer];
        if (!timeStr || timeStr === '--:--') return;
        
        const [h, m] = timeStr.split(':').map(Number);
        const prayerTime = h * 3600 + m * 60;
        
        const countdownMinutes = adzanCountdownDurations[prayer] || 10;
        const triggerTime = prayerTime - (countdownMinutes * 60);
        
        if (currentTime >= triggerTime && currentTime <= triggerTime + 59) {
            if (!countdownState.active) {
                showPopupAdzan(prayer);
            }
        }
    });
    
    // ==================== CEK WAKTU IMSAK UNTUK POPUP ====================
    const imsakStr = adzanSchedule.imsak;
    if (imsakStr && imsakStr !== '--:--') {
        const [ih, im] = imsakStr.split(':').map(Number);
        const imsakTime = ih * 3600 + im * 60;
        
        // Putar rooster tepat pada waktu imsak (dalam toleransi 10 detik)
        if (currentTime >= imsakTime && currentTime <= imsakTime + 10) {
            playRoosterAudio();
        }
        
        // Tampilkan popup Imsak jika tepat waktu
        if (currentTime >= imsakTime && currentTime <= imsakTime + 1) {
            if (!imsakState.active) {
                showPopupImsak();
            }
        }
    }

    // ==================== CEK WAKTU SYURUQ UNTUK POPUP ====================
    const syuruqStr = adzanSchedule.syuruq;
    if (syuruqStr && syuruqStr !== '--:--') {
        const [sh, sm] = syuruqStr.split(':').map(Number);
        const syuruqTime = sh * 3600 + sm * 60;
        
        // Tampilkan popup Syuruq jika tepat waktu
        if (currentTime >= syuruqTime && currentTime <= syuruqTime + 1) {
            if (!syuruqState.active) {
                showPopupSyuruq();
            }
        }
    }
}

// ==================== FUNGSI ROOSTER AUDIO ====================
var roosterPlayedToday = false; // Flag untuk mencegah loop
var lastRoosterDate = null; // Tanggal terakhir rooster diputar

function playRoosterAudio() {
    const today = new Date().toDateString();
    
    // Cek apakah rooster sudah diputar hari ini
    if (lastRoosterDate === today && roosterPlayedToday) {
        return; // Sudah diputar hari ini, jangan putar lagi
    }
    
    const audioRooster = document.getElementById('audioRooster');
    if (audioRooster) {
        // Reset flag jika hari sudah berganti
        if (lastRoosterDate !== today) {
            roosterPlayedToday = false;
            lastRoosterDate = today;
        }
        
        // Jika belum diputar hari ini, putar audio
        if (!roosterPlayedToday) {
            audioRooster.currentTime = 0;
            audioRooster.play().then(() => {
                roosterPlayedToday = true;
                console.log('Rooster audio played for imsak');
            }).catch(e => {
                console.log('Error playing rooster audio:', e);
            });
        }
    }
}

// Reset flag rooster setiap hari (setelah tengah malam)
function resetRoosterFlag() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Reset setelah tengah malam (00:00 - 00:10)
    if (hours === 0 && minutes <= 10) {
        roosterPlayedToday = false;
        lastRoosterDate = null;
    }
}

// Panggil resetRoosterFlag setiap menit
setInterval(resetRoosterFlag, 60000);

// ==================== FUNGSI POPUP IMSAK ====================
function showPopupImsak() {
    if (imsakState.active) return;
    
    // Set state aktif
    imsakState.active = true;
    imsakState.beepCount = 15;
    
    // Tampilkan popup di tengah layar
    const popup = document.getElementById('popupImsakOverlay');
    popup.style.display = 'flex';
    popup.style.justifyContent = 'center';
    popup.style.alignItems = 'center';
    
    // Update teks
    document.getElementById('popupImsakText').textContent = 'Waktu Imsak telah Tiba';
    document.getElementById('imsakBeepCounter').textContent = '15';
    
    // Mulai countdown beep
    startImsakBeep();
}

function startImsakBeep() {
    if (imsakState.interval) {
        clearInterval(imsakState.interval);
    }
    
    const beepElement = document.getElementById('imsakBeepCounter');
    const progressElement = document.getElementById('imsakProgress');
    
    // Putar beep pertama kali
    playBeep();
    
    imsakState.interval = setInterval(() => {
        // Kurangi counter
        imsakState.beepCount--;
        
        // Update tampilan
        beepElement.textContent = imsakState.beepCount;
        
        const progress = (imsakState.beepCount / 15) * 100;
        progressElement.style.width = `${progress}%`;
        
        // Putar beep untuk setiap hitungan
        if (imsakState.beepCount > 0) {
            playBeep();
        }
        
        // Selesai setelah 15 beep
        if (imsakState.beepCount <= 0) {
            clearInterval(imsakState.interval);
            imsakState.interval = null;
            imsakState.active = false;
            
            // Tutup popup setelah 2 detik
            setTimeout(() => {
                document.getElementById('popupImsakOverlay').style.display = 'none';
            }, 2000);
        }
    }, 1000); // 1 detik antara beep
}

// ==================== FUNGSI POPUP SYURUQ ====================
function showPopupSyuruq() {
    if (syuruqState.active) return;
    
    // Set state aktif
    syuruqState.active = true;
    syuruqState.beepCount = 15;
    
    // Tampilkan popup di tengah layar
    const popup = document.getElementById('popupSyuruqOverlay');
    popup.style.display = 'flex';
    popup.style.justifyContent = 'center';
    popup.style.alignItems = 'center';
    
    // Update teks
    document.getElementById('popupSyuruqText').textContent = 'Waktu Syuruq telah Tiba';
    document.getElementById('syuruqBeepCounter').textContent = '15';
    
    // Mulai countdown beep
    startSyuruqBeep();
}

function startSyuruqBeep() {
    if (syuruqState.interval) {
        clearInterval(syuruqState.interval);
    }
    
    const beepElement = document.getElementById('syuruqBeepCounter');
    const progressElement = document.getElementById('syuruqProgress');
    
    // Putar beep pertama kali
    playBeep();
    
    syuruqState.interval = setInterval(() => {
        // Kurangi counter
        syuruqState.beepCount--;
        
        // Update tampilan
        beepElement.textContent = syuruqState.beepCount;
        
        const progress = (syuruqState.beepCount / 15) * 100;
        progressElement.style.width = `${progress}%`;
        
        // Putar beep untuk setiap hitungan
        if (syuruqState.beepCount > 0) {
            playBeep();
        }
        
        // Selesai setelah 15 beep
        if (syuruqState.beepCount <= 0) {
            clearInterval(syuruqState.interval);
            syuruqState.interval = null;
            syuruqState.active = false;
            
            // Tutup popup setelah 2 detik
            setTimeout(() => {
                document.getElementById('popupSyuruqOverlay').style.display = 'none';
            }, 2000);
        }
    }, 1000); // 1 detik antara beep
}

// ==================== FUNGSI PLAY BEEP ====================
function playBeep() {
    const audioBeep = document.getElementById('audioBeep');
    if (audioBeep) {
        // Reset audio ke awal
        audioBeep.currentTime = 0;
        
        // Putar audio (non-loop)
        audioBeep.play().catch(e => {
            console.log('Error playing beep:', e);
        });
    }
}

// ==================== EVENT LISTENER UNTUK POPUP ====================
function setupPopupEvents() {
    // Popup Imsak - tutup jika diklik di luar
    const popupImsak = document.getElementById('popupImsakOverlay');
    if (popupImsak) {
        popupImsak.addEventListener('click', function(e) {
            if (e.target === this) {
                stopAllAudio();
                this.style.display = 'none';
            }
        });
    }
    
    // Popup Syuruq - tutup jika diklik di luar
    const popupSyuruq = document.getElementById('popupSyuruqOverlay');
    if (popupSyuruq) {
        popupSyuruq.addEventListener('click', function(e) {
            if (e.target === this) {
                stopAllAudio();
                this.style.display = 'none';
            }
        });
    }
}

// Panggil fungsi setup di init
// Tambahkan ini di window.onload setelah setupSimpleEvents()
setupPopupEvents();

// ==================== CAROUSEL ====================
function initCarousels() {
    // Load slider settings
    loadSliderSettings();

    // Load carousel kiri
    loadLeftCarousel();
    
    // Load carousel kanan
    loadMainCarousel();
    
    // Setup transisi carousel
    setupCarouselTransitions();

        // Nonaktifkan pause behavior pada carousel
    disableCarouselPause();
}

// Fungsi untuk menonaktifkan pause behavior
function disableCarouselPause() {
    // Untuk slide kiri
    var leftCarousel = document.getElementById('leftCarousel');
    if (leftCarousel) {
        // Set attribute untuk mencegah pause
        leftCarousel.setAttribute('data-bs-pause', 'false');
        leftCarousel.setAttribute('data-bs-touch', 'false');
        
        // Setup event listener untuk mencegah pause saat hover/click
        leftCarousel.addEventListener('mouseenter', function(e) {
            e.stopPropagation();
            return false;
        });
        
        leftCarousel.addEventListener('click', function(e) {
            e.stopPropagation();
            return false;
        });
    }
    
    // Untuk slide kanan
    var mainCarousel = document.getElementById('mainCarousel');
    if (mainCarousel) {
        // Set attribute untuk mencegah pause
        mainCarousel.setAttribute('data-bs-pause', 'false');
        mainCarousel.setAttribute('data-bs-touch', 'false');
        
        // Setup event listener untuk mencegah pause saat hover/click
        mainCarousel.addEventListener('mouseenter', function(e) {
            e.stopPropagation();
            return false;
        });
        
        mainCarousel.addEventListener('click', function(e) {
            e.stopPropagation();
            return false;
        });
    }
    
}

// Tambahkan fungsi baru untuk setup transisi
function setupCarouselTransitions() {
    // Setup untuk slide kiri (slide down)
    var leftCarousel = document.getElementById('leftCarousel');
    if (leftCarousel) {
        // Tambahkan class untuk transisi slide down
        var leftCarouselInner = leftCarousel.querySelector('.carousel-inner');
        if (leftCarouselInner) {
            leftCarouselInner.style.overflow = 'hidden';
        }
    }
    
    // Setup untuk slide kanan (opacity)
    var mainCarousel = document.getElementById('mainCarousel');
    if (mainCarousel) {
        // Tambahkan class untuk transisi opacity
        var mainCarouselInner = mainCarousel.querySelector('.carousel-inner');
        if (mainCarouselInner) {
            mainCarouselInner.classList.add('carousel-fade');
        }
    }
}

function loadLeftCarousel() {
    try {
        var inner = document.getElementById('leftCarouselInner');
        if (!inner) return;
        
        // Buat semua slide yang mungkin
        var allSlides = [
            { num: 1, content: createLeftSlide1() },
            { num: 2, content: createLeftSlide2() },
            { num: 3, content: createLeftSlide3() },
            { num: 4, content: createLeftSlide4() }
        ];
        
        // Filter slide yang TIDAK dihidden dan ADA kontennya
        var activeSlides = [];
        for (var i = 0; i < allSlides.length; i++) {
            var slide = allSlides[i];
                        
            // Skip jika konten kosong/null
            if (!slide.content || slide.content.trim() === '') {
                console.log('Slide ' + slide.num + ' has no content');
                continue;
            }
            
            activeSlides.push({
                num: slide.num,
                content: slide.content,
                id: 'slide' + slide.num
            });
        }
        
        // Jika tidak ada slide aktif, buat default
        if (activeSlides.length === 0) {
            activeSlides.push({
                num: 0,
                content: '<h5><i class="bi bi-info-circle text-primary"></i> Informasi</h5>' +
                        '<div class="alert alert-warning mt-3">Belum ada konten untuk ditampilkan</div>',
                id: 'default'
            });
        }
        
        // Kosongkan carousel inner
        inner.innerHTML = '';
        
        // Tambahkan hanya slide aktif
        for (var j = 0; j < activeSlides.length; j++) {
            var slide = activeSlides[j];
            var item = document.createElement('div');
            item.className = 'carousel-item' + (j === 0 ? ' active' : '');
            item.id = slide.id;
            item.innerHTML = '<div class="left-card"><div class="card-body">' + 
                           slide.content + '</div></div>';
            inner.appendChild(item);
        }
        
        // Setup carousel berdasarkan jumlah slide
        setupCarouselForSlideCount(activeSlides.length);
        
    } catch (e) {
        console.log('Error loadLeftCarousel:', e);
    }
}

// FUNGSI BARU UNTUK SETUP CAROUSEL
function setupCarouselForSlideCount(slideCount) {
    var leftCarousel = document.getElementById('leftCarousel');
    if (!leftCarousel) return;
    
    // Update indicators
    updateCarouselIndicators(slideCount);
    
    // Jika hanya 1 slide, nonaktifkan carousel
    if (slideCount <= 1) {
        // Nonaktifkan autoplay
        leftCarousel.setAttribute('data-bs-interval', '0');
        
        // Sembunyikan indicators
        var indicators = leftCarousel.querySelector('.carousel-indicators');
        if (indicators) indicators.style.display = 'none';
        
        // Sembunyikan tombol prev/next
        var prevBtn = leftCarousel.querySelector('.carousel-control-prev');
        var nextBtn = leftCarousel.querySelector('.carousel-control-next');
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        
        // Nonaktifkan swipe/touch
        leftCarousel.setAttribute('data-bs-touch', 'false');
    } else {
        // Aktifkan carousel
        var interval = 10000; // 10 detik
        leftCarousel.setAttribute('data-bs-interval', interval);
        
        // Tampilkan indicators
        var indicators = leftCarousel.querySelector('.carousel-indicators');
        if (indicators) indicators.style.display = 'flex';
        
        // Tampilkan tombol prev/next
        var prevBtn = leftCarousel.querySelector('.carousel-control-prev');
        var nextBtn = leftCarousel.querySelector('.carousel-control-next');
        if (prevBtn) prevBtn.style.display = 'block';
        if (nextBtn) nextBtn.style.display = 'block';
    }
}

function updateCarouselIndicators(slideCount) {
    try {
        var indicatorsContainer = document.querySelector('#leftCarousel .carousel-indicators');
        if (!indicatorsContainer) {
            // Buat indicators jika belum ada
            var carousel = document.getElementById('leftCarousel');
            if (carousel) {
                indicatorsContainer = document.createElement('div');
                indicatorsContainer.className = 'carousel-indicators';
                carousel.querySelector('.carousel-inner').after(indicatorsContainer);
            }
        }
        
        if (indicatorsContainer) {
            indicatorsContainer.innerHTML = '';
            
            for (var i = 0; i < slideCount; i++) {
                var button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#leftCarousel');
                button.setAttribute('data-bs-slide-to', i);
                button.setAttribute('aria-label', 'Slide ' + (i + 1));
                if (i === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicatorsContainer.appendChild(button);
            }
        }
    } catch (e) {
        console.log('Error updateCarouselIndicators:', e);
    }
}

function createLeftSlide1() {
    var message = settings.customMessage || 'Selamat datang di Masjid Mahallah TV';
    return '<h5><i class="bi bi-chat-text text-primary"></i> </h5>' +
           '<div style="margin-top: 20px; font-size: 20px; line-height: 1.6;">' +
           message.replace(/\\n/g, '<br>') +
           '</div>';
}

function createLeftSlide2() {
    try {
        if (typeof hariIslamData !== 'undefined') {

            // Pastikan updateHijri sudah dipanggil saat init
            var hijriDate = window.currentHijriDate;

            if (!hijriDate) {
                console.log('Hijri date object belum tersedia');
                return null;
            }

            var messages = hariIslamData.getMessages(hijriDate);

            if (messages && messages.length > 0) {
                var content = '<h5><i class="bi bi-calendar-event text-success"></i> Hari Besar Islam Hari Ini</h5>';
                for (var i = 0; i < messages.length; i++) {
                    content += '<div class="alert alert-success mt-2" style="font-size: 30px;">' + messages[i] + '</div>';
                }
                return content;
            }

            return null;
        }
    } catch (e) {
        console.log('Error createLeftSlide2:', e);
    }
    return null;
}


function createLeftSlide3() {
    try {
        if (typeof ayatHaditsData !== 'undefined' && ayatHaditsData.length > 0) {
            // Ambil ayat/hadits berikutnya (secara bergantian)
            var item = getNextAyatHadits();
            
            if (!item) return null;
            
            return '<h5 style="font-size: 20px;"><i class="bi bi-book text-warning"></i> ' + item.jenis + '</h5>' +
                   '<small class="text-muted" style="font-size: 14px;">Tentang: ' + item.tentang + '</small>' +
                   '<div style="font-size: 20px; text-align: right; direction: rtl; margin-top: 15px; line-height: 1.8;">' +
                   item.isi +
                   '</div>' +
                   '<div style="font-size: 20px; font-style: italic; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; line-height: 1.5;">' +
                   '<i class="bi bi-translate text-primary me-2"></i>' + item.terjemahan +
                   '</div>';
        }
    } catch (e) {
        console.log('Error createLeftSlide3:', e);
    }
    return null;
}

function createLeftSlide4() {
    try {
        if (typeof hariIslamData === 'undefined') {
            return null;
        }

        // Ambil langsung object Hijriyah global
        var hijriDate = window.currentHijriDate;

        if (!hijriDate) {
            return null;
        }
        var upcomingEvents = hariIslamData.getUpcomingEvents(hijriDate, 2);

        if (upcomingEvents && upcomingEvents.length > 0) {
            var hijriMonths = [
                'Muharram', 'Safar', 'Rabiul Awal', 'Rabiul Akhir',
                'Jumadil Awal', 'Jumadil Akhir', 'Rajab', 'Sya\'ban',
                'Ramadhan', 'Syawal', 'Dzulqaidah', 'Dzulhijjah'
            ];

            var content = '<h5><i class="bi bi-clock-history text-info"></i> Hari Besar Islam</h5>';

            for (var i = 0; i < upcomingEvents.length; i++) {
                var event = upcomingEvents[i];
                var daysText = event.days === 1 ? 'besok' : event.days + ' hari lagi';
                var monthName = hijriMonths[event.month - 1] || ('Bulan ' + event.month);

                content +=
                    '<div class="alert alert-info mt-2">' +
                        '<div class="fw-bold" style="font-size: 24px;">' + daysText + '</div>' +
                        '<div style="font-size: 20px;">' + event.name + '</div>' +
                        '<small class="text-muted" style="font-size: 20px;">' +
                            event.day + ' ' + monthName + ' ' + hijriDate.year + ' H' +
                        '</small>' +
                    '</div>';
            }

            return content;
        }

    } catch (e) {
        console.log('Error createLeftSlide4:', e);
    }

    return null;
}


function loadMainCarousel() {
    const carouselInner = document.getElementById('mainCarouselInner');
    carouselInner.innerHTML = '';

    let images = settings.uploadedImages;

    // ‚úÖ JIKA BELUM ADA GAMBAR ‚Üí DEFAULT
    if (!images || images.length === 0) {
        images = defaultMainImages.map(src => ({ src }));
    }

    images.forEach((item, index) => {
        const carouselItem = document.createElement('div');
        carouselItem.className = 'carousel-item' + (index === 0 ? ' active' : '');

        const img = document.createElement('img');

        // üîë AMBIL SRC YANG BENAR
        img.src = item.data || item.src;

        img.className = 'd-block w-100';
        img.style.objectFit = 'cover';

        carouselItem.appendChild(img);
        carouselInner.appendChild(carouselItem);
    });

}

// ==================== FUNGSI UNTUK MENDAPATKAN AYAT/HADITS BERIKUTNYA ====================
function getNextAyatHadits() {
    if (!ayatHaditsData || ayatHaditsData.length === 0) {
        return null;
    }
    
    // Jika semua sudah ditampilkan, reset history
    if (ayatHaditsHistory.length >= ayatHaditsData.length) {
        ayatHaditsHistory = [];
    }
    
    // Cari indeks yang belum ditampilkan
    var availableIndices = [];
    for (var i = 0; i < ayatHaditsData.length; i++) {
        if (!ayatHaditsHistory.includes(i)) {
            availableIndices.push(i);
        }
    }
    
    // Pilih secara acak dari yang belum ditampilkan
    if (availableIndices.length > 0) {
        var randomIndex = Math.floor(Math.random() * availableIndices.length);
        ayatHaditsIndex = availableIndices[randomIndex];
    } else {
        // Jika semua sudah ditampilkan, mulai lagi dari awal
        ayatHaditsHistory = [];
        ayatHaditsIndex = Math.floor(Math.random() * ayatHaditsData.length);
    }
    
    // Tambahkan ke history
    ayatHaditsHistory.push(ayatHaditsIndex);
    
    return ayatHaditsData[ayatHaditsIndex];
}

// ==================== FUNGSI UNTUK MENDETEKSI PERGANTIAN SLIDE ====================
function setupCarouselSlideDetection() {
    // Deteksi untuk slide kiri
    var leftCarousel = document.getElementById('leftCarousel');
    if (leftCarousel) {
        leftCarousel.addEventListener('slide.bs.carousel', function(event) {
            var nextSlideIndex = event.to;
            console.log('Slide kiri berganti ke:', nextSlideIndex);
            
            // Jika slide 3 yang akan aktif, refresh kontennya
            if (nextSlideIndex === 2) { // Index 2 = Slide 3 (0-based index)
                refreshSlide3Content();
            }
        });
    }
    
    // Deteksi untuk slide kanan
    var mainCarousel = document.getElementById('mainCarousel');
    if (mainCarousel) {
        mainCarousel.addEventListener('slide.bs.carousel', function(event) {
            console.log('Slide kanan berganti ke:', event.to);
            // Tidak perlu refresh ayat/hadits untuk slide kanan
        });
    }
}

// ==================== FUNGSI REFRESH SLIDE 3 ====================
function refreshSlide3Content() {
    try {
        var slide3Element = document.getElementById('slide3');
        if (slide3Element) {
            var newContent = createLeftSlide3();
            if (newContent) {
                slide3Element.innerHTML = '<div class="left-card"><div class="card-body">' + 
                                         newContent + '</div></div>';
                console.log('Slide 3 diperbarui dengan ayat/hadits baru');
                
                // Tambahkan efek visual halus (optional)
                slide3Element.style.opacity = '0';
                setTimeout(function() {
                    slide3Element.style.opacity = '1';
                }, 100);
            }
        }
    } catch (e) {
        console.log('Error refreshSlide3Content:', e);
    }
}

// ==================== FUNGSI INISIALISASI (TAMBAHKAN INI) ====================
function initAyatHaditsSystem() {
    try {
        // Setup deteksi pergantian slide
        setupCarouselSlideDetection();
        
        // Reset history saat aplikasi dimulai
        ayatHaditsHistory = [];
        
        // Load ayat/hadits pertama kali
        if (typeof ayatHaditsData !== 'undefined' && ayatHaditsData.length > 0) {
            getNextAyatHadits(); // Inisialisasi pertama
        }
        
        console.log('Ayat/Hadits system initialized with ' + (ayatHaditsData?.length || 0) + ' items');
    } catch (e) {
        console.log('Error initAyatHaditsSystem:', e);
    }
}


// ==================== RUNNING TEXT ====================
function initRunningText() {
    updateRunningTextUI();
}

function updateRunningTextUI() {
    try {
        var runningText = settings.runningText || 'Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba';
        var display = document.getElementById('runningTextDisplay');
        if (display) {
            display.innerHTML = runningText;
        }
    } catch (e) {
        console.log('Error updateRunningTextUI:', e);
    }
}

// ==================== SETTINGS & FORMS ====================
function loadSettings() {
    try {
        // Load dari localStorage
        var savedSettings = localStorage.getItem('masjidSettings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
        }
        
        // Update UI dengan data yang di-load
        document.getElementById('masjidName').textContent = settings.masjidName || 'Mahallah TV';
        document.getElementById('masjidAddress').textContent = settings.masjidAddress || 'Dev: Rocky CHK';
        document.getElementById('namaMasjidInput').value = settings.masjidName || 'Mahallah TV';
        document.getElementById('alamatMasjidInput').value = settings.masjidAddress || 'Dev: Rocky CHK';
        document.getElementById('pesanTeksInput').value = settings.customMessage ? settings.customMessage.replace(/\\n/g, '\n') : 'Selamat datang di Masjid Mahallah TV\\n\\nMari bersama menjaga kebersihan dan ketertiban masjid untuk kenyamanan beribadah kita semua.';
        
        // Load running texts
        loadRunningTextsFromSettings();
        
        document.getElementById('charCount').textContent = (settings.customMessage ? settings.customMessage.length - (settings.customMessage.match(/\\\\n/g) || []).length * 2 : 0) + '/300 karakter';
        
        // ========== PERBAIKAN: LOAD LOGO DENGAN PRIORITAS ==========
        loadLogoWithPriority();
        
        // Load gambar
        updateImagesList();
        
    } catch (e) {
        console.log('Error loadSettings:', e);
    }
}

function saveSettings() {
    try {
        // Cek ukuran settings sebelum disimpan (logo base64 bisa besar)
        var settingsStr = JSON.stringify(settings);
        if (settingsStr.length > 5000000) { // 5MB limit
            console.warn('Settings terlalu besar, kompres atau hapus data yang tidak perlu');
            
            // Hapus logo dari settings jika terlalu besar, simpan terpisah
            if (settings.logo) {
                // Simpan logo terpisah di localStorage
                localStorage.setItem('masjid_logo', settings.logo);
                delete settings.logo; // Hapus dari settings object
                settingsStr = JSON.stringify(settings);
            }
        }
        
        localStorage.setItem('masjidSettings', settingsStr);
        return true;
    } catch (e) {
        console.error('Error saveSettings:', e);
        
        // Coba hapus logo jika masih error
        if (settings.logo) {
            delete settings.logo;
            try {
                localStorage.setItem('masjidSettings', JSON.stringify(settings));
                return true;
            } catch (e2) {
                console.error('Masih error setelah hapus logo:', e2);
                return false;
            }
        }
        
        return false;
    }
}


function setupFormEvents() {
    // Form Data Masjid
    var masjidForm = document.getElementById('masjidDataForm');
    if (masjidForm) {
        masjidForm.onsubmit = function(e) {
            e.preventDefault();
            saveMasjidData();
            return false;
        };
    }
    
    // Form Running Text
    var runningTextForm = document.getElementById('runningTextForm');
    if (runningTextForm) {
        runningTextForm.onsubmit = function(e) {
            e.preventDefault();
            saveRunningText();
            return false;
        };
    }

    // Setup tombol Tambah Running Text
    var addRunningTextBtn = document.getElementById('addRunningTextBtn');
    if (addRunningTextBtn) {
        addRunningTextBtn.addEventListener('click', addRunningTextInput);
    }
    
    // Form Pesan Teks
    var pesanTeksForm = document.getElementById('pesanTeksForm');
    if (pesanTeksForm) {
        pesanTeksForm.onsubmit = function(e) {
            e.preventDefault();
            savePesanTeks();
            return false;
        };
    }
    
    // Character counter
    var pesanInput = document.getElementById('pesanTeksInput');
    if (pesanInput) {
        pesanInput.oninput = function() {
            var count = this.value.length;
            document.getElementById('charCount').textContent = count + '/300 karakter';
        };
    }
}

function saveMasjidData() {
    settings.masjidName = document.getElementById('namaMasjidInput').value || 'Mahallah TV';
    settings.masjidAddress = document.getElementById('alamatMasjidInput').value || 'Dev: Rocky CHK';
    
    // Handle logo upload
    var logoInput = document.getElementById('logoInput');
    var logoFile = logoInput.files[0];
    
    if (logoFile) {
        // Validasi file
        if (logoFile.size > 500 * 1024) { // 500KB
            showToast('‚ö†Ô∏è Ukuran logo terlalu besar (maks 500KB)', 'warning');
            return false;
        }
        
        if (!logoFile.type.match('image.*')) {
            showToast('‚ö†Ô∏è Format file harus gambar', 'warning');
            return false;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            // Simpan ke localStorage (priority 1)
            localStorage.setItem('masjid_logo', e.target.result);
            
            // Juga simpan ke settings object
            settings.logo = e.target.result;
            
            // Update semua preview logo
            updateAllLogoPreviews(e.target.result);
            
            // Simpan settings ke localStorage
            if (saveSettings()) {
                showToast('‚úÖ Logo berhasil diupload!', 'success');
                
                // Reset input file
                logoInput.value = '';
            }
        };
        
        reader.onerror = function() {
            showToast('‚ùå Gagal membaca file logo', 'danger');
        };
        
        reader.readAsDataURL(logoFile);
    } else {
        // Jika tidak ada file baru, tetap simpan data text
        if (saveSettings()) {
            showToast('‚úÖ Data masjid berhasil disimpan!', 'success');
        }
    }
    
    // Update UI text
    document.getElementById('masjidName').textContent = settings.masjidName;
    document.getElementById('masjidAddress').textContent = settings.masjidAddress;
    
    return false;
}

// ==================== FUNGSI UPDATE LOGO ====================
function updateAllLogoPreviews(logoData) {
    try {
        // 1. Update logo di header SAJA
        var headerLogo = document.getElementById('masjidLogo');
        if (headerLogo) {
            headerLogo.src = logoData;
            headerLogo.onerror = function() {
                this.src = 'logo.png';
            };
        }
        
        // 2. Update logo preview di form SAJA
        var previewLogo = document.getElementById('logoPreviewImg');
        if (previewLogo) {
            previewLogo.src = logoData;
            previewLogo.onerror = function() {
                this.src = 'logo.png';
            };
        }
        
        // 3. SPLASH SCREEN LOGO TIDAK DIUPDATE
        // Logo splash screen tetap menggunakan logo default
        
        console.log('Logo updated (header & preview only)');
    } catch (e) {
        console.error('Error updateAllLogoPreviews:', e);
    }
}

function saveRunningText() {
    settings.runningText = document.getElementById('runningText1').value || '';
    
    if (saveSettings()) {
        updateRunningTextUI();
        alert('Running text berhasil disimpan!');
    }
}

function savePesanTeks() {
    var message = document.getElementById('pesanTeksInput').value || '';
    settings.customMessage = message.replace(/\n/g, '\\n');
    
    if (saveSettings()) {
        loadLeftCarousel();
        alert('Pesan teks berhasil disimpan!');
    }
}

function setupPrayerClickEvents() {
  const prayers = ['Imsak', 'Shubuh', 'Syuruq', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'];
  
  prayers.forEach(prayer => {
    const element = document.getElementById(`time${prayer}`);
    if (element) {
      // Untuk imsak dan syuruq tidak perlu popup, langsung tampilkan modal pengaturan
      if (prayer === 'Imsak' || prayer === 'Syuruq') {
        element.addEventListener('click', () => {
          currentPrayer = prayer.toLowerCase();
          showPrayerSettings(currentPrayer);
        });
      } else {
        // Untuk sholat lainnya, tampilkan modal pengaturan
        element.addEventListener('click', () => {
          currentPrayer = prayer.toLowerCase();
          showPrayerSettings(currentPrayer);
        });
      }
    }
  });
}

function showPrayerSettings(prayer) {
  const prayerNames = {
    imsak: 'Imsak',
    shubuh: 'Shubuh',
    syuruq: 'Syuruq',
    dzuhur: 'Dzuhur',
    ashar: 'Ashar',
    maghrib: 'Maghrib',
    isya: 'Isya'
  };
  
  // Update label modal
  document.getElementById('prayerNameLabel').innerText = `Pengaturan Waktu ${prayerNames[prayer]}`;
  document.getElementById('currentOffset').textContent = `Offset: ${prayerOffsets[prayer] || 0} menit`;
  
  // Tampilkan modal
  const modal = new bootstrap.Modal(document.getElementById('prayerSettingsModal'));
  modal.show();
}

// Fungsi untuk membersihkan localStorage jika penuh
function cleanupLocalStorage() {
    try {
        // Cek total size
        var totalSize = 0;
        for (var key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length * 2; // UTF-16, 2 bytes per char
            }
        }
        
        console.log('Total localStorage size:', (totalSize / 1024 / 1024).toFixed(2), 'MB');
        
        // Jika melebihi 4MB, hapus data lama
        if (totalSize > 4 * 1024 * 1024) { // 4MB
            console.log('LocalStorage hampir penuh, membersihkan...');
            
            // Hapus gambar yang sudah tidak digunakan
            var uploadedImages = settings.uploadedImages || [];
            var imagesToKeep = uploadedImages.slice(-5); // Keep only last 5 images
            
            if (uploadedImages.length > imagesToKeep.length) {
                settings.uploadedImages = imagesToKeep;
                saveSettings();
                console.log('Dihapus', uploadedImages.length - imagesToKeep.length, 'gambar lama');
            }
        }
    } catch (e) {
        console.error('Error cleanupLocalStorage:', e);
    }
}

function updatePrayerTimeWithOffset(prayer, offset) {
    const element = document.getElementById(`time${prayer.charAt(0).toUpperCase() + prayer.slice(1)}`);
    if (!element || !adzanSchedule[prayer]) return;
    
    const timeStr = adzanSchedule[prayer];
    const [hours, minutes] = timeStr.split(":").map(Number);
    const date = new Date();
    date.setHours(hours);
    date.setMinutes(minutes + offset);
    
    const newTime = 
        date.getHours().toString().padStart(2, '0') + ':' + 
        date.getMinutes().toString().padStart(2, '0');
    
    element.innerText = newTime;
    adzanSchedule[prayer] = newTime;
}

function createPrayerClickHandler(prayer) {
    return function() {
        currentPrayer = prayer.toLowerCase();
        showPrayerSettings(currentPrayer);
    };
}

function showCountdownForm(type) {
  // Tutup modal utama terlebih dahulu
  const mainModal = bootstrap.Modal.getInstance(document.getElementById('prayerSettingsModal'));
  if (mainModal) mainModal.hide();
  
  let title = '';
  let formHtml = '';
  let headerColor = '';
  
  if (type === 'adzan') {
    title = `Countdown Adzan ${currentPrayer.charAt(0).toUpperCase() + currentPrayer.slice(1)}`;
    headerColor = 'bg-success text-white';
    formHtml = `
      <div class="mb-3">
        <label class="form-label">Durasi Countdown (menit)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="countdownValue" 
                 value="${adzanCountdownDurations[currentPrayer] || 10}" min="1" max="60">
          <span class="input-group-text">menit</span>
        </div>
        <small class="text-muted">Waktu countdown sebelum adzan dimulai</small>
      </div>
    `;
  } else if (type === 'iqamah') {
    title = `Countdown Iqamah ${currentPrayer.charAt(0).toUpperCase() + currentPrayer.slice(1)}`;
    headerColor = 'bg-warning text-white';
    formHtml = `
      <div class="mb-3">
        <label class="form-label">Durasi Iqamah (menit)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="countdownValue" 
                 value="${iqamahCountdownDurations[currentPrayer] || 25}" min="1" max="120">
          <span class="input-group-text">menit</span>
        </div>
        <small class="text-muted">Waktu menunggu antara adzan dan iqamah</small>
      </div>
    `;
  } else if (type === 'overlay') {
    title = `Durasi Overlay ${currentPrayer.charAt(0).toUpperCase() + currentPrayer.slice(1)}`;
    headerColor = 'bg-dark text-white';
    formHtml = `
      <div class="mb-3">
        <label class="form-label">Durasi Overlay Hitam (menit)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="countdownValue" 
                 value="${overlayBlackDurations[currentPrayer] || 15}" min="1" max="180">
          <span class="input-group-text">menit</span>
        </div>
        <small class="text-muted">Durasi tampilan layar hitam setelah iqamah</small>
      </div>
    `;
  }
  
  // Tambahkan tombol aksi
  formHtml += `
    <div class="d-grid gap-2 mt-4">
      <button class="btn btn-primary" onclick="saveCountdownSettings('${type}')">
        <i class="bi bi-save me-2"></i>Simpan Pengaturan
      </button>
      <button class="btn btn-secondary" onclick="backToMainSettings()">
        <i class="bi bi-arrow-left me-2"></i>Kembali
      </button>
    </div>
  `;
  
  // Update modal form countdown
  document.getElementById('countdownTitle').innerText = title;
  document.getElementById('countdownModalHeader').className = `modal-header ${headerColor}`;
  document.getElementById('countdownFormBody').innerHTML = formHtml;
  
  // Tampilkan modal form
  const formModal = new bootstrap.Modal(document.getElementById('countdownFormModal'));
  formModal.show();
}

function saveCountdownSettings(type) {
  const input = document.getElementById('countdownValue');
  if (!input) return;
  
  const value = parseInt(input.value);
  if (!value || value < 1) {
    showToast('‚ö†Ô∏è Masukkan nilai yang valid!', 'warning');
    return;
  }
  
  if (type === 'adzan') {
    adzanCountdownDurations[currentPrayer] = value;
    localStorage.setItem('adzanCountdownDurations', JSON.stringify(adzanCountdownDurations));
    showToast('‚úÖ Countdown Adzan disimpan!', 'success');
  } else if (type === 'iqamah') {
    iqamahCountdownDurations[currentPrayer] = value;
    localStorage.setItem('iqamahCountdownDurations', JSON.stringify(iqamahCountdownDurations));
    showToast('‚úÖ Countdown Iqamah disimpan!', 'success');
  } else if (type === 'overlay') {
    overlayBlackDurations[currentPrayer] = value;
    localStorage.setItem('overlayBlackDurations', JSON.stringify(overlayBlackDurations));
    showToast('‚úÖ Durasi Overlay disimpan!', 'success');
  }
  
  // Tutup modal form
  const formModal = bootstrap.Modal.getInstance(document.getElementById('countdownFormModal'));
  if (formModal) formModal.hide();
  
  // Kembali ke modal utama
  setTimeout(() => {
    const mainModal = new bootstrap.Modal(document.getElementById('prayerSettingsModal'));
    mainModal.show();
  }, 300);
}

function backToMainSettings() {
  // Tutup modal form
  const formModal = bootstrap.Modal.getInstance(document.getElementById('countdownFormModal'));
  if (formModal) formModal.hide();
  
  // Tampilkan kembali modal utama
  setTimeout(() => {
    const mainModal = new bootstrap.Modal(document.getElementById('prayerSettingsModal'));
    mainModal.show();
  }, 300);
}


function setupMenuEvents() {
    // Close black overlay
    var closeBtn = document.getElementById('closeBlackOverlay');
    if (closeBtn) {
        closeBtn.onclick = function() {
            document.getElementById('blackOverlay').style.display = 'none';
            
            // Tampilkan kembali elemen
            const adzanTable = document.querySelector('.adzan-table');
            const marquee = document.querySelector('.marquee');
            
            if (adzanTable) adzanTable.style.display = 'block';
            if (marquee) marquee.style.display = 'block';
            
            // Clear interval jika ada
            if (blackOverlayInterval) {
                clearTimeout(blackOverlayInterval);
                blackOverlayInterval = null;
            }
        };
    }
    
    // Reset masjid data
    var resetBtn = document.getElementById('resetMasjidData');
    if (resetBtn) {
        resetBtn.onclick = function() {
            // Di dalam resetBtn.onclick:
            if (confirm('Reset data masjid ke default?')) {
                settings.masjidName = 'Mahallah TV';
                settings.masjidAddress = 'Dev : Rocky CHK';
                settings.runningText = 'Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba, Agar tidak mengganggu kekhusyukan Shalat || Allah Subhanahu Wa Ta\'ala berfirman : "Sesungguhnya shalat itu mencegah dari (perbuatan) keji dan mungkar" (Q.S. Al-Ankabut:45).';
                settings.runningTexts = [settings.runningText];
                settings.customMessage = 'Selamat datang di Masjid Mahallah TV\\n\\nMari bersama menjaga kebersihan dan ketertiban masjid untuk kenyamanan beribadah kita semua.';
                settings.uploadedImages = [];
                settings.themeColor = '#005a31';
                settings.logo = null; // Hapus logo dari settings
                
                // HAPUS logo dari localStorage
                localStorage.removeItem('masjid_logo');
                
                if (saveSettings()) {
                    // Reset logo ke default
                    updateAllLogoPreviews('logo.png');
                    
                    loadSettings();
                    loadLeftCarousel();
                    loadMainCarousel();
                    updateRunningTextUI();
                    applyThemeColor('#005a31', true);
                    showToast('‚úÖ Data berhasil direset!', 'success');
                }
            }
        };
    }
    
    // Close popup dengan klik di luar
    const popups = ['popupAdzanOverlay', 'iqamahPopupOverlay'];
    popups.forEach(popupId => {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    
                    // Clear intervals
                    if (popupId === 'popupAdzanOverlay' && adzanCountdownInterval) {
                        clearInterval(adzanCountdownInterval);
                        adzanCountdownInterval = null;
                        popupAdzanActive = false;
                    }
                    if (popupId === 'iqamahPopupOverlay' && iqamahCountdownInterval) {
                        clearInterval(iqamahCountdownInterval);
                        iqamahCountdownInterval = null;
                        popupIqamahActive = false;
                    }
                }
            });
        }
    });
}

// Fungsi untuk preview logo sebelum diupload
function setupLogoPreview() {
    var logoInput = document.getElementById('logoInput');
    if (logoInput) {
        logoInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                var file = this.files[0];
                
                // Validasi
                if (file.size > 500 * 1024) {
                    showToast('‚ö†Ô∏è Ukuran logo terlalu besar (maks 500KB)', 'warning');
                    this.value = '';
                    return;
                }
                
                if (!file.type.match('image.*')) {
                    showToast('‚ö†Ô∏è Format file harus gambar', 'warning');
                    this.value = '';
                    return;
                }
                
                var reader = new FileReader();
                reader.onload = function(e) {
                    // Tampilkan preview DI FORM SAJA
                    var previewImg = document.getElementById('logoPreviewImg');
                    if (previewImg) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    }
                    
                    // Tampilkan juga DI HEADER (preview real-time)
                    var headerLogo = document.getElementById('masjidLogo');
                    if (headerLogo) {
                        headerLogo.src = e.target.result;
                    }
                    
                    // SPLASH SCREEN TIDAK DIUPDATE
                };
                
                reader.onerror = function() {
                    showToast('‚ùå Gagal membaca file logo', 'danger');
                };
                
                reader.readAsDataURL(file);
            }
        });
    }
}

// Panggil di setupSimpleEvents():
function setupSimpleEvents() {
    // Setup form submit untuk STB
    setupFormEvents();
    
    // Setup click events untuk waktu sholat
    setupPrayerClickEvents();
    
    // Setup menu events
    setupMenuEvents();
    
    // Setup logo preview
    setupLogoPreview();
}

// ==================== FUNGSI OFFSET WAKTU MANUAL ====================
// Ganti fungsi adjustOffset():
function adjustOffset(amount) {
  if (!currentPrayer) return;

  // Pastikan offset ada
  if (typeof prayerOffsets[currentPrayer] !== 'number') {
    prayerOffsets[currentPrayer] = 0;
  }

  // Reset atau tambah/kurang
  if (amount === 0) {
    prayerOffsets[currentPrayer] = 0;
  } else {
    prayerOffsets[currentPrayer] += amount;
  }

  // Batasi offset -60 s/d +60 menit
  prayerOffsets[currentPrayer] = Math.max(
    -60,
    Math.min(60, prayerOffsets[currentPrayer])
  );

  // üî¥ HITUNG ULANG DARI JAM ASLI (BUKAN DARI JAM YANG SUDAH BERGESER)
  const baseTime = originalPrayerTimes[currentPrayer];
  adzanSchedule[currentPrayer] = addMinutes(
    baseTime,
    prayerOffsets[currentPrayer]
  );

  // Update UI
  document.getElementById('currentOffset').textContent =
    `Offset: ${prayerOffsets[currentPrayer]} menit`;

  updatePrayerTimesUI();

  // üî¥ SIMPAN HANYA OFFSET (INI KUNCI AGAR RELOAD TIDAK RUSAK)
  localStorage.setItem('prayerOffsets', JSON.stringify(prayerOffsets));

  // Toast
  const message =
    amount === 0
      ? 'Offset direset ke 0'
      : `Offset diubah ${amount > 0 ? '+' : ''}${amount} menit`;

  showToast(`‚úÖ ${message}`, 'success');
}

// ==================== LOAD OFFSET DARI LOCALSTORAGE ====================
function loadPrayerOffsets() {
  try {
    const savedOffsets = localStorage.getItem('prayerOffsets');
    if (savedOffsets) {
      prayerOffsets = JSON.parse(savedOffsets);
    } else {
      prayerOffsets = {
        imsak: 0,
        shubuh: 0,
        syuruq: 0,
        dzuhur: 0,
        ashar: 0,
        maghrib: 0,
        isya: 0
      };
    }
    
    // Load manual times if exists
    const savedManualTimes = localStorage.getItem('manualPrayerTimes');
    if (savedManualTimes) {
      adzanSchedule = JSON.parse(savedManualTimes);
      
      // üî¥ PERUBAHAN: Update UI untuk semua sholat yang ada di schedule
      const prayers = ['imsak', 'shubuh', 'syuruq', 'dzuhur', 'ashar', 'maghrib', 'isya'];
      prayers.forEach(prayer => {
        if (adzanSchedule[prayer]) {
          const element = document.getElementById(`time${prayer.charAt(0).toUpperCase() + prayer.slice(1)}`);
          if (element) {
            element.textContent = adzanSchedule[prayer];
          }
        }
      });
    }
    
  } catch (e) {
    console.log('Error loading prayer offsets:', e);
  }
}


function showToast(message, type = 'info') {
    try {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => toast.remove());
        
        const colors = {
            success: '#28a745',
            warning: '#ffc107',
            danger: '#dc3545',
            info: '#17a2b8'
        };
        
        const icons = {
            success: 'bi-check-circle',
            warning: 'bi-exclamation-triangle',
            danger: 'bi-x-circle',
            info: 'bi-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.style.backgroundColor = colors[type] || colors.info;
        toast.style.color = 'white';
        toast.style.border = 'none';
        toast.style.padding = '15px';
        toast.style.borderRadius = '5px';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi ${icons[type]} me-2" style="font-size: 1.2rem;"></i>
                <div>${message}</div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    } catch (e) {
        console.log('Error showToast:', e);
    }
}

// ==================== UPLOAD GAMBAR ====================
function uploadImages() {
    var input = document.getElementById('imageUpload');
    if (!input.files.length) {
        alert('Pilih gambar terlebih dahulu!');
        return;
    }
    
    // Batasi maksimal 5 gambar
    if (settings.uploadedImages.length + input.files.length > 5) {
        alert('Maksimal 5 gambar!');
        return;
    }
    
    var files = input.files;
    var uploadedCount = 0;
    
    for (var i = 0; i < files.length; i++) {
        var file = files[i];
        
        // Batasi ukuran (1MB)
        if (file.size > 1024 * 1024) {
            alert('Gambar ' + file.name + ' terlalu besar (maks 1MB)');
            continue;
        }
        
        var reader = new FileReader();
        reader.onload = (function(file) {
            return function(e) {
                settings.uploadedImages.push({
                    name: file.name,
                    data: e.target.result,
                    timestamp: new Date().getTime()
                });
                
                uploadedCount++;
                
                if (uploadedCount === files.length) {
                    if (saveSettings()) {
                        updateImagesList();
                        loadMainCarousel();
                        input.value = '';
                        alert('Gambar berhasil diupload!');
                    }
                }
            };
        })(file);
        
        reader.readAsDataURL(file);
    }
}

function updateImagesList() {
    var container = document.getElementById('imagesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!settings.uploadedImages || settings.uploadedImages.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Belum ada gambar</p>';
        return;
    }
    
    for (var i = 0; i < settings.uploadedImages.length; i++) {
        var img = settings.uploadedImages[i];
        var col = document.createElement('div');
        col.className = 'col-6 mb-3';
        col.innerHTML = '<div class="card image-preview">' +
                       '<img src="' + img.data + '" class="card-img-top" style="height: 100px; object-fit: cover;">' +
                       '<div class="card-body p-2">' +
                       '<small class="d-block text-truncate mb-1">' + img.name + '</small>' +
                       '<button class="btn btn-sm btn-danger w-100" onclick="deleteImage(' + i + ')">' +
                       '<i class="bi bi-trash"></i> Hapus</button></div></div>';
        container.appendChild(col);
    }
}

function deleteImage(index) {
    if (confirm('Hapus gambar ini?')) {
        settings.uploadedImages.splice(index, 1);
        if (saveSettings()) {
            updateImagesList();
            loadMainCarousel();
            alert('Gambar berhasil dihapus!');
        }
    }
}

// ==================== PENGATURAN DURASI SLIDER ====================

// Mapping nilai ke durasi (dalam detik)
var sliderDurationMap = {
    0: 10,   // Nilai 0 = 10 detik
    1: 15,   // Nilai 1 = 15 detik (+5)
    2: 20,   // Nilai 2 = 20 detik (+10) 
    3: 25,   // Nilai 3 = 25 detik (+15)
    4: 30,   // Nilai 4 = 30 detik (+20)
    5: 40    // Nilai 5 = 40 detik (+30)
};

// Default duration index (bukan detik langsung)
var sliderSettings = {
    leftCarousel: 0,  // Index 0 = 10 detik
    mainCarousel: 0   // Index 0 = 10 detik
};

// Fungsi untuk mendapatkan durasi dari index
function getDurationFromIndex(index) {
    return sliderDurationMap[index] || 10;
}

// Load settings dari localStorage
function loadSliderSettings() {
    try {
        var saved = localStorage.getItem('sliderSettings');
        if (saved) {
            var parsed = JSON.parse(saved);
            sliderSettings.leftCarousel = parsed.leftCarousel || 0;
            sliderSettings.mainCarousel = parsed.mainCarousel || 0;
            
            // Update carousel intervals
            updateCarouselIntervals();
        }
    } catch (e) {
        console.log('Error loadSliderSettings:', e);
    }
}

// Update interval carousel berdasarkan settings
function updateCarouselIntervals() {
    try {
        // Convert durasi dari index ke milidetik
        var leftDuration = getDurationFromIndex(sliderSettings.leftCarousel);
        var mainDuration = getDurationFromIndex(sliderSettings.mainCarousel);
        
        var leftInterval = leftDuration * 1000;
        var mainInterval = mainDuration * 1000;
        
        // Update left carousel
        var leftCarousel = document.getElementById('leftCarousel');
        if (leftCarousel) {
            leftCarousel.setAttribute('data-bs-interval', leftInterval);
            
            // Jika carousel sudah diinisialisasi, update interval-nya
            var leftCarouselInstance = bootstrap.Carousel.getInstance(leftCarousel);
            if (leftCarouselInstance) {
                leftCarouselInstance._config.interval = leftInterval;
            }
        }
        
        // Update main carousel
        var mainCarousel = document.getElementById('mainCarousel');
        if (mainCarousel) {
            mainCarousel.setAttribute('data-bs-interval', mainInterval);
            
            // Jika carousel sudah diinisialisasi, update interval-nya
            var mainCarouselInstance = bootstrap.Carousel.getInstance(mainCarousel);
            if (mainCarouselInstance) {
                mainCarouselInstance._config.interval = mainInterval;
            }
        }
        

    } catch (e) {
        console.log('Error updateCarouselIntervals:', e);
    }
}

// Update form pengaturan durasi slider
function showSliderSettingsForm() {
    // Tutup offcanvas menu terlebih dahulu
    var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mainOffcanvasMenu'));
    if (offcanvas) {
        offcanvas.hide();
    }
    
    var leftDuration = getDurationFromIndex(sliderSettings.leftCarousel);
    var mainDuration = getDurationFromIndex(sliderSettings.mainCarousel);
    
    var formHTML = `
        <form id="sliderSettingsForm">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Pengaturan Durasi Slider</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-arrow-left-right me-2 text-primary"></i>
                            Slide Kiri (Pesan, Ayat, Hari Besar)
                        </label>
                        <div class="d-flex align-items-center justify-content-center">
                            <button type="button" class="btn btn-outline-primary btn-lg" onclick="adjustSliderDuration('left', -1)">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                            <div class="mx-3 text-center" style="min-width: 120px;">
                                <div id="leftDurationValue" class="display-6">${sliderSettings.leftCarousel}</div>
                                <small class="text-muted">Nilai (0-5)</small>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-lg" onclick="adjustSliderDuration('left', 1)">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-center">
                            <div class="badge bg-info p-2">
                                <i class="bi bi-clock me-1"></i>
                                Durasi: <span id="leftActualDuration">${leftDuration}</span> detik
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-images me-2 text-success"></i>
                            Slide Gambar (Kanan)
                        </label>
                        <div class="d-flex align-items-center justify-content-center">
                            <button type="button" class="btn btn-outline-success btn-lg" onclick="adjustSliderDuration('main', -1)">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                            <div class="mx-3 text-center" style="min-width: 120px;">
                                <div id="mainDurationValue" class="display-6">${sliderSettings.mainCarousel}</div>
                                <small class="text-muted">Nilai (0-5)</small>
                            </div>
                            <button type="button" class="btn btn-outline-success btn-lg" onclick="adjustSliderDuration('main', 1)">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-center">
                            <div class="badge bg-info p-2">
                                <i class="bi bi-clock me-1"></i>
                                Durasi: <span id="mainActualDuration">${mainDuration}</span> detik
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Konversi Nilai ke Durasi:</strong><br>
                        0 = 10 detik (default)<br>
                        1 = 15 detik (+5)<br>
                        2 = 20 detik (+10)<br>
                        3 = 25 detik (+15)<br>
                        4 = 30 detik (+20)<br>
                        5 = 40 detik (+30)
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-warning" onclick="resetSliderSettings()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset ke Default
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveSliderSettings()">
                            <i class="bi bi-check-circle me-2"></i>Simpan
                        </button>
                    </div>
                </div>
            </div>
        </form>
    `;
    
    document.getElementById('countdownFormBody').innerHTML = formHTML;
    document.getElementById('countdownTitle').textContent = 'Durasi Slider';
    document.getElementById('countdownModalHeader').className = 'modal-header bg-primary text-white';
    
    var modal = new bootstrap.Modal(document.getElementById('countdownFormModal'));
    modal.show();
}

// Fungsi untuk mengatur durasi slider
function adjustSliderDuration(type, change) {
    var currentValue;
    var valueElement;
    var actualElement;
    
    if (type === 'left') {
        currentValue = sliderSettings.leftCarousel;
        valueElement = 'leftDurationValue';
        actualElement = 'leftActualDuration';
    } else {
        currentValue = sliderSettings.mainCarousel;
        valueElement = 'mainDurationValue';
        actualElement = 'mainActualDuration';
    }
    
    // Batasi nilai 0-5
    var newValue = currentValue + change;
    if (newValue < 0) newValue = 0;
    if (newValue > 5) newValue = 5;
    
    // Update nilai
    if (type === 'left') {
        sliderSettings.leftCarousel = newValue;
    } else {
        sliderSettings.mainCarousel = newValue;
    }
    
    // Update tampilan
    var newDuration = getDurationFromIndex(newValue);
    document.getElementById(valueElement).textContent = newValue;
    document.getElementById(actualElement).textContent = newDuration;
    
    // Update langsung tanpa perlu save dulu (preview)
    updateCarouselIntervals();
}

// Reset ke default
function resetSliderSettings() {
    sliderSettings.leftCarousel = 0;
    sliderSettings.mainCarousel = 0;
    
    // Update tampilan
    document.getElementById('leftDurationValue').textContent = '0';
    document.getElementById('mainDurationValue').textContent = '0';
    document.getElementById('leftActualDuration').textContent = '10';
    document.getElementById('mainActualDuration').textContent = '10';
    
    // Update carousel
    updateCarouselIntervals();
    
    // Tidak langsung simpan, hanya preview
    showSimpleNotification('Durasi direset ke default (10 detik)', 'info');
}

// Simpan settings
function saveSliderSettings() {
    if (saveSliderSettingsToStorage()) {
        var modal = bootstrap.Modal.getInstance(document.getElementById('countdownFormModal'));
        if (modal) modal.hide();
        showSimpleNotification('Pengaturan durasi slider berhasil disimpan!', 'success');
    } else {
        showSimpleNotification('Gagal menyimpan pengaturan!', 'error');
    }
}

function saveSliderSettingsToStorage() {
    try {
        localStorage.setItem('sliderSettings', JSON.stringify(sliderSettings));
        return true;
    } catch (e) {
        console.log('Error saveSliderSettingsToStorage:', e);
        return false;
    }
}

//////AKHIR FUNGSI PENGATURAN SLIDER////////////

// ==================== LOAD COUNTDOWN SETTINGS ====================
function loadCountdownSettings() {
    try {
        // Load dari localStorage atau gunakan default
        var savedAdzanDurations = localStorage.getItem('adzanCountdownDurations');
        var savedIqamahDurations = localStorage.getItem('iqamahCountdownDurations');
        var savedOverlayDurations = localStorage.getItem('overlayBlackDurations');
        var savedPrayerOffsets = localStorage.getItem('prayerOffsets');
        
        // Default values untuk countdown adzan (menit)
        var defaultAdzan = {
            imsak: 10, shubuh: 10, syuruq: 10, dzuhur: 10, ashar: 10, maghrib: 10, isya: 10
        };
        
        // Default values untuk countdown iqamah (menit)
        var defaultIqamah = {
            imsak: 0, shubuh: 25, syuruq: 0, dzuhur: 25, ashar: 25, maghrib: 3, isya: 25
        };
        
        // Default values untuk overlay (menit)
        var defaultOverlay = {
            imsak: 0, shubuh: 15, syuruq: 0, dzuhur: 15, ashar: 15, maghrib: 15, isya: 60
        };
        
        // Load atau gunakan default
        adzanCountdownDurations = savedAdzanDurations ? JSON.parse(savedAdzanDurations) : defaultAdzan;
        iqamahCountdownDurations = savedIqamahDurations ? JSON.parse(savedIqamahDurations) : defaultIqamah;
        overlayBlackDurations = savedOverlayDurations ? JSON.parse(savedOverlayDurations) : defaultOverlay;
        prayerOffsets = savedPrayerOffsets ? JSON.parse(savedPrayerOffsets) : {};
        
        // Inisialisasi nilai 0 untuk prayerOffsets jika belum ada
        var prayers = ['imsak', 'shubuh', 'syuruq', 'dzuhur', 'ashar', 'maghrib', 'isya'];
        prayers.forEach(prayer => {
            if (prayerOffsets[prayer] === undefined) {
                prayerOffsets[prayer] = 0;
            }
        });
        

        
    } catch (e) {
        console.log('Error loadCountdownSettings:', e);
        
        // Gunakan default values jika error
        adzanCountdownDurations = {
            imsak: 10, shubuh: 10, syuruq: 10, dzuhur: 10, ashar: 10, maghrib: 10, isya: 10
        };
        iqamahCountdownDurations = {
            imsak: 0, shubuh: 25, syuruq: 0, dzuhur: 25, ashar: 25, maghrib: 3, isya: 25
        };
        overlayBlackDurations = {
            imsak: 0, shubuh: 15, syuruq: 0, dzuhur: 15, ashar: 15, maghrib: 15, isya: 60
        };
        prayerOffsets = {
            imsak: 0, shubuh: 0, syuruq: 0, dzuhur: 0, ashar: 0, maghrib: 0, isya: 0
        };
    }
}

// Fungsi untuk menampilkan notifikasi sederhana (STB compatible)
function showSimpleNotification(message, type) {
    var notification = document.createElement('div');
    notification.className = 'position-fixed top-0 end-0 m-3 p-3 rounded shadow';
    
    if (type === 'success') {
        notification.style.backgroundColor = '#d1e7dd';
        notification.style.color = '#0f5132';
        notification.style.border = '1px solid #badbcc';
    } else {
        notification.style.backgroundColor = '#f8d7da';
        notification.style.color = '#842029';
        notification.style.border = '1px solid #f5c2c7';
    }
    
    notification.innerHTML = '<i class="bi bi-info-circle me-2"></i>' + message;
    notification.style.zIndex = '99999';
    
    document.body.appendChild(notification);
    
    // Hapus setelah 3 detik
    setTimeout(function() {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// ==================== FUNGSI PENGATURAN WARNA ====================
function loadThemeSettings() {
    try {
        // Load warna tema dari localStorage
        var savedTheme = localStorage.getItem('themeColor');
        if (savedTheme) {
            settings.themeColor = savedTheme;
            applyThemeColor(savedTheme, false); // false = jangan save ulang
        }
    } catch (e) {
        console.log('Error loadThemeSettings:', e);
    }
}

function changeThemeColor(color) {
    settings.themeColor = color;
    applyThemeColor(color, true);
    showToast(`‚úÖ Warna tema berhasil diubah!`, 'success');
}

function applyCustomColor() {
    var color = document.getElementById('customColorPicker').value;
    changeThemeColor(color);
}

function applyThemeColor(color, saveToStorage = true) {
    try {
        // Simpan ke localStorage jika diminta
        if (saveToStorage) {
            localStorage.setItem('themeColor', color);
        }
        
        // Update warna picker kustom
        var colorPicker = document.getElementById('customColorPicker');
        if (colorPicker) {
            colorPicker.value = color;
        }
        
        // Terapkan warna ke semua elemen yang relevan
        updateCSSVariables(color);
        
        // Update semua komponen yang menggunakan warna
        updateHeaderColor(color);
        updateTableColor(color);
        updateButtonColors(color);
        updateProgressBars(color);
        
    } catch (e) {
        console.log('Error applyThemeColor:', e);
    }
}

function updateCSSVariables(color) {
    // Konversi warna HEX ke RGB untuk transparansi
    var rgb = hexToRgb(color);
    
    // Set CSS variables
    document.documentElement.style.setProperty('--theme-primary', color);
    document.documentElement.style.setProperty('--theme-primary-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
    
    // Update class Bootstrap jika perlu
    updateBootstrapColors(color);
}

function updateHeaderColor(color) {
    var headers = document.querySelectorAll('.header, .bg-primary');
    headers.forEach(header => {
        if (header.classList.contains('header')) {
            header.style.background = `linear-gradient(135deg, ${color} 0%, ${adjustColor(color, 30)} 100%)`;
        } else if (header.classList.contains('bg-primary')) {
            header.style.backgroundColor = color;
        }
    });
}

function updateTableColor(color) {
    var tableHeaders = document.querySelectorAll('.adzan-table th');
    tableHeaders.forEach(th => {
        th.style.backgroundColor = color;
    });
    
    var activeCells = document.querySelectorAll('.adzan-table td.active');
    for (var i = 0; i < activeCells.length; i++) {
        activeCells[i].style.backgroundColor = color;
    }
}

function updateButtonColors(color) {
    var primaryButtons = document.querySelectorAll('.btn-primary, .btn-success');
    primaryButtons.forEach(btn => {
        if (btn.classList.contains('btn-primary')) {
            btn.style.backgroundColor = color;
            btn.style.borderColor = color;
        }
    });
}

function updateProgressBars(color) {
    var progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        if (bar.classList.contains('bg-primary') || bar.classList.contains('bg-success')) {
            bar.style.backgroundColor = color;
        }
    });
}

function updateBootstrapColors(color) {
    // Update Bootstrap color classes
    var style = document.createElement('style');
    style.id = 'theme-custom-css';
    style.textContent = `
        .bg-primary { background-color: ${color} !important; }
        .btn-primary { background-color: ${color} !important; border-color: ${color} !important; }
        .btn-primary:hover { background-color: ${adjustColor(color, -20)} !important; border-color: ${adjustColor(color, -20)} !important; }
        .text-primary { color: ${color} !important; }
        .border-primary { border-color: ${color} !important; }
        .progress-bar.bg-primary { background-color: ${color} !important; }
        .progress-bar.bg-success { background-color: ${color} !important; }
        .btn-outline-primary { color: ${color} !important; border-color: ${color} !important; }
        .btn-outline-primary:hover { background-color: ${color} !important; color: white !important; }
        .carousel-indicators button.active { background-color: ${color} !important; }
    `;
    
    // Hapus style lama jika ada
    var oldStyle = document.getElementById('theme-custom-css');
    if (oldStyle) {
        oldStyle.remove();
    }
    
    document.head.appendChild(style);
}

function adjustColor(color, amount) {
    // Fungsi untuk menyesuaikan kecerahan warna
    var rgb = hexToRgb(color);
    
    // Adjust brightness
    rgb.r = Math.max(0, Math.min(255, rgb.r + amount));
    rgb.g = Math.max(0, Math.min(255, rgb.g + amount));
    rgb.b = Math.max(0, Math.min(255, rgb.b + amount));
    
    return rgbToHex(rgb.r, rgb.g, rgb.b);
}

function hexToRgb(hex) {
    // Konversi HEX ke RGB
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : {r: 0, g: 90, b: 49}; // Default hijau
}

function rgbToHex(r, g, b) {
    // Konversi RGB ke HEX
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

function resetThemeColor() {
    var defaultColor = '#005a31';
    settings.themeColor = defaultColor;
    applyThemeColor(defaultColor, true);
    showToast(`‚úÖ Warna tema direset ke default!`, 'success');
}

// ==================== FUNGSI UNTUK TOMBOL UPGRADE ====================
function showUpgradeFromMenu() {
    // Tutup offcanvas info aplikasi
    var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasInfoAplikasi'));
    if (offcanvas) {
        offcanvas.hide();
    }
    
    // Tampilkan popup pilihan paket
    if (typeof offlineLicense !== 'undefined' && offlineLicense.showPackageSelectionPopup) {
        offlineLicense.showPackageSelectionPopup();
    }
}

// ==================== KEYBOARD NAVIGATION UNTUK STB ====================
document.onkeydown = function(e) {
    e = e || window.event;
    var key = e.keyCode || e.which;
    
    switch(key) {
        case 13: // Enter/OK
            var activeElement = document.activeElement;
            if (activeElement && activeElement.click) {
                activeElement.click();
            }
            break;
            
        case 27: // Escape
            // Tutup semua modal dan offcanvas
            var modals = document.querySelectorAll('.modal.show, .offcanvas.show');
            for (var i = 0; i < modals.length; i++) {
                var modal = bootstrap.Modal.getInstance(modals[i]);
                var offcanvas = bootstrap.Offcanvas.getInstance(modals[i]);
                
                if (modal) modal.hide();
                if (offcanvas) offcanvas.hide();
            }
            break;
            
        case 112: // F1 - Settings
            document.getElementById('settingsBtn').click();
            break;
            
        case 37: // Left arrow
            var prevBtn = document.querySelector('.carousel-control-prev');
            if (prevBtn) prevBtn.click();
            break;

        case 39: // Right arrow (untuk masuk dari splash screen)
            var splashScreen = document.getElementById('splashScreen');
            if (splashScreen && splashScreen.style.display !== 'none') {
                enterMainApp();
            } else {
                var nextBtn = document.querySelector('.carousel-control-next');
                if (nextBtn) nextBtn.click();
            }
            break;
    }
};

// ==================== STB OPTIMIZATION ====================
if (navigator.userAgent.toLowerCase().includes('stb') || !('ontouchstart' in window)) {
    
    // Disable heavy animations, tapi pertahankan transisi carousel sederhana
    var style = document.createElement('style');
    style.textContent = 
        '.carousel-item { transition: none !important; } ' +
        '#leftCarousel .carousel-inner .carousel-item { transition: transform 0.8s ease-in-out !important; } ' +
        '#mainCarousel .carousel-inner .carousel-item { transition: opacity 0.8s ease-in-out !important; } ' +
        // Nonaktifkan pointer events pada carousel items
        '#leftCarousel .carousel-item, ' +
        '#mainCarousel .carousel-item { pointer-events: none !important; } ' +
        '#leftCarousel .carousel-item .left-card, ' +
        '#mainCarousel .carousel-item img { pointer-events: none !important; } ' +
        // Biarkan indicators tetap bisa diklik
        '#leftCarousel .carousel-indicators button, ' +
        '#mainCarousel .carousel-indicators button { pointer-events: auto !important; cursor: pointer !important; }';
    document.head.appendChild(style);
    
    // Load slider settings untuk STB
    loadSliderSettings();
    
    // Setup transisi dan disable pause
    setTimeout(function() {
        setupCarouselTransitions();
        disableCarouselPause();
    }, 1000);
}

function applyPrayerOffsets() {
  for (var prayer in originalPrayerTimes) {
    const baseTime = originalPrayerTimes[prayer];
    const offset = prayerOffsets[prayer] || 0;
    adzanSchedule[prayer] = addMinutes(baseTime, offset);
  }
  updatePrayerTimesUI();
}

// ==================== SPLASH SCREEN ====================
function showSplashScreen() {
    // Tampilkan splash screen
    document.getElementById('splashScreen').style.display = 'flex';
    
    // Auto hide setelah 10 detik (fallback)
    setTimeout(function() {
        var splashScreen = document.getElementById('splashScreen');
        if (splashScreen && splashScreen.style.display !== 'none') {
            enterMainApp();
        }
    }, 10000);
}

function enterMainApp() {
    // Mainkan audio pendek untuk mengaktifkan audio context
    activateAudioContext();
    
    // Fade out splash screen
    var splashScreen = document.getElementById('splashScreen');
    splashScreen.classList.add('fade-out');
    
    // Sembunyikan setelah animasi selesai
    setTimeout(function() {
        splashScreen.style.display = 'none';
        
        // Reset semua audio state
        resetAllAudioStates();
        
        // Simpan logo ke localStorage jika ada di settings
        if (settings.logo && !localStorage.getItem('masjid_logo')) {
            localStorage.setItem('masjid_logo', settings.logo);
            console.log('Logo auto-saved to localStorage');
        }
        
    }, 500);
}

function activateAudioContext() {
    try {
        // Buat audio context dan play audio pendek
        var audio = new Audio();
        audio.src = 'beep.mp3'; // Gunakan file beep yang kecil
        audio.volume = 0.1; // Volume rendah
        audio.play().then(function() {
            // Hentikan segera
            audio.pause();
            audio.currentTime = 0;
            
            console.log('Audio context activated successfully');
            
            // Set flag bahwa user sudah berinteraksi
            window.userInteracted = true;
            
        }).catch(function(e) {
            console.log('Audio activation attempt:', e);
            // Tetap set flag untuk melanjutkan
            window.userInteracted = true;
        });
    } catch (e) {
        console.log('Error in audio activation:', e);
        window.userInteracted = true;
    }
}

function testAudioPlayback() {
    // Coba mainkan shalawat sebentar untuk testing
    var audioBeep = document.getElementById('audioBeep');
    if (audioBeep) {
        audioBeep.volume = 0.3;
        audioBeep.play().then(function() {
            // Hentikan setelah 2 detik
            setTimeout(function() {
                audioBeep.pause();
                audioBeep.currentTime = 0;
            }, 2000);
        }).catch(function(e) {
            console.log('Test audio playback failed:', e);
        });
    }
}

function resetAllAudioStates() {
    // Reset semua state audio
    if (window.countdownState) {
        countdownState.active = false;
        countdownState.type = null;
        countdownState.prayer = null;
        countdownState.remaining = 0;
        if (countdownState.interval) {
            clearInterval(countdownState.interval);
            countdownState.interval = null;
        }
    }
    
    if (window.warningState) {
        warningState.active = false;
        if (warningState.interval) {
            clearInterval(warningState.interval);
            warningState.interval = null;
        }
    }
    
    // Hentikan semua audio
    stopAllAudio();
}

// ==================== FUNGSI RESET APLIKASI TANPA REFRESH ====================
function softResetApp() {
    console.log('Soft reset aplikasi tanpa refresh halaman');
    
    // 1. Reset semua state audio
    stopAllAudio();
    
    // 2. Reset countdown state
    countdownState.active = false;
    countdownState.type = null;
    countdownState.prayer = null;
    countdownState.remaining = 0;
    if (countdownState.interval) {
        clearInterval(countdownState.interval);
        countdownState.interval = null;
    }
    
    // 3. Reset warning state
    warningState.active = false;
    if (warningState.interval) {
        clearInterval(warningState.interval);
        warningState.interval = null;
    }
    
    // 4. Reset imsak & syuruq state
    imsakState.active = false;
    imsakState.beepCount = 0;
    if (imsakState.interval) {
        clearInterval(imsakState.interval);
        imsakState.interval = null;
    }
    
    syuruqState.active = false;
    syuruqState.beepCount = 0;
    if (syuruqState.interval) {
        clearInterval(syuruqState.interval);
        syuruqState.interval = null;
    }
    
    // 5. Tutup semua popup
    const popups = [
        'popupAdzanOverlay',
        'iqamahPopupOverlay', 
        'warningPopupOverlay',
        'popupImsakOverlay',
        'popupSyuruqOverlay'
    ];
    
    popups.forEach(id => {
        const popup = document.getElementById(id);
        if (popup) popup.style.display = 'none';
    });
    
    // 6. Reset carousel ke slide pertama
    try {
        const leftCarousel = bootstrap.Carousel.getInstance(document.getElementById('leftCarousel'));
        const mainCarousel = bootstrap.Carousel.getInstance(document.getElementById('mainCarousel'));
        
        if (leftCarousel) leftCarousel.to(0);
        if (mainCarousel) mainCarousel.to(0);
    } catch (e) {
        console.log('Error resetting carousel:', e);
    }
    
    // 7. Update waktu/jadwal
    updateClock();
    updateDate();
    updateHijri();
    highlightNextPrayer();
    
    // 8. Update Jumat display
    updateJumatDisplay();
    
    // 9. Tampilkan toast notifikasi
    showToast('üîÑ Aplikasi direset tanpa refresh halaman', 'info');

    // 10. Reset sistem ayat/hadits
    ayatHaditsHistory = [];
    ayatHaditsIndex = 0;
    
    // Refresh slide 3 jika sedang aktif
    var slide3Element = document.getElementById('slide3');
    if (slide3Element && slide3Element.classList.contains('active')) {
        refreshSlide3Content();
    }
    
    console.log('Soft reset selesai');
}

// ==================== INTEGRASI SCREEN MANAGER ====================
// Pastikan screen manager tidak mengganggu fungsi utama

// Di window.onload, tambahkan:
window.onload = function() {
    console.log('Aplikasi Adzan Mahallah TV v2.0 diinisialisasi');
    
    // Deteksi STB
    isSTB = navigator.userAgent.toLowerCase().includes('stb') || !('ontouchstart' in window);

    // Cek dan update tampilan Jumat
    updateJumatDisplay();

    // Tampilkan splash screen pertama kali
    showSplashScreen();

    // Inisialisasi komponen
    initClock();
    initDate();
    initHijri();
    initPrayerTimes();
    initCarousels();
    initRunningText();

    // Inisialisasi refresh ayat/hadits ‚Üê TAMBAH INI
    initAyatHaditsSystem();

    // Load data dari localStorage
    loadSettings();
    
    // Load pengaturan warna tema
    loadThemeSettings();

    // Load countdown settings
    loadCountdownSettings();
    loadPrayerOffsets();

    updateHijri();
 
    applyPrayerOffsets();

    // Cleanup localStorage jika perlu
    cleanupLocalStorage();

    // Setup event listeners sederhana
    setupSimpleEvents();
    
    // Update Jumat display setiap menit (untuk handle pergantian hari)
    setInterval(updateJumatDisplay, 60000);
    
    // Periksa apakah screen manager sudah dimuat
    if (typeof screenManager !== 'undefined' && screenManager) {
        console.log('Screen Manager terintegrasi');
        
        // Jangan start jika screen sedang off
        if (screenManager.isScreenOff) {
            console.log('Screen sedang dalam keadaan OFF');
        }
    }
};

// Fungsi untuk memuat logo dengan prioritas
function loadLogoWithPriority() {
    try {
        var headerLogo = document.getElementById('masjidLogo');
        var previewLogo = document.getElementById('logoPreviewImg');
        
        if (!headerLogo || !previewLogo) return;
        
        // PRIORITAS 1: Logo dari localStorage (terbaru)
        var savedLogo = localStorage.getItem('masjid_logo');
        
        // PRIORITAS 2: Logo dari settings object
        var settingsLogo = settings.logo;
        
        // PRIORITAS 3: Logo default
        var defaultLogo = 'logo.png';
        
        var logoToUse = savedLogo || settingsLogo || defaultLogo;
        
        // Update hanya header dan preview
        if (headerLogo) headerLogo.src = logoToUse;
        if (previewLogo) previewLogo.src = logoToUse;
        
        // Juga simpan ke settings untuk konsistensi
        if (savedLogo && !settings.logo) {
            settings.logo = savedLogo;
            saveSettings();
        }
        
    } catch (e) {
        console.error('Error loadLogoWithPriority:', e);
        // Fallback ke default
        if (headerLogo) headerLogo.src = 'logo.png';
        if (previewLogo) previewLogo.src = 'logo.png';
    }
}

// Modifikasi fungsi stopAllAudio untuk integrasi
function stopAllAudio() {
    try {
        const splashScreen = document.getElementById('splashScreen');
        if (splashScreen && splashScreen.style.display !== 'none') {
            return;
        }
        const audioElements = [
            'audioShalawat',
            'audioAdzan', 
            'audioBeep',
            'audioRooster'
        ];
        
        audioElements.forEach(id => {
            const audio = document.getElementById(id);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio.loop = false;
            }
        });
        
        // Hentikan interval Imsak dan Syuruq jika aktif
        if (window.imsakState && imsakState.interval) {
            clearInterval(imsakState.interval);
            imsakState.interval = null;
            imsakState.active = false;
        }
        
        if (window.syuruqState && syuruqState.interval) {
            clearInterval(syuruqState.interval);
            syuruqState.interval = null;
            syuruqState.active = false;
        }
        
        // Reset flag rooster jika audio dihentikan paksa
        if (countdownState.prayer === 'imsak') {
            if (window.roosterPlayedToday !== undefined) {
                roosterPlayedToday = false;
            }
        }
        
        // Tutup popup Imsak dan Syuruq jika terbuka
        const popups = ['popupImsakOverlay', 'popupSyuruqOverlay', 'popupAdzanOverlay', 'iqamahPopupOverlay', 'warningPopupOverlay'];
        popups.forEach(popupId => {
            const popup = document.getElementById(popupId);
            if (popup) popup.style.display = 'none';
        });
        
    } catch (e) {
        console.log('Error stopAllAudio:', e);
    }
}

// ==================== FUNGSI RUNNING TEXT DINAMIS ====================
var runningTextCount = 1; // Mulai dari 1 karena RT1 sudah ada

function addRunningTextInput() {
    runningTextCount++;
    
    if (runningTextCount > 3) {
        showToast('‚ö†Ô∏è Maksimal 3 running text!', 'warning');
        return;
    }
    
    // Buat elemen input baru
    var newInputGroup = document.createElement('div');
    newInputGroup.className = 'mb-3 running-text-group';
    newInputGroup.id = 'runningTextGroup' + runningTextCount;
    
    newInputGroup.innerHTML = `
        <div class="form-label-container">
            <label class="form-label fw-bold">Running Text ${runningTextCount}</label>
            <button type="button" class="delete-running-text-btn" onclick="removeRunningTextInput(${runningTextCount})">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <input type="text" class="form-control" id="runningText${runningTextCount}" 
               placeholder="Masukkan running text ${runningTextCount}">
    `;
    
    // Tambahkan sebelum tombol "Tambah Running Text"
    document.getElementById('runningTextInputs').appendChild(newInputGroup);
    
    // Load data yang sudah tersimpan
    loadSavedRunningText(runningTextCount);
    
    // Update tombol jika sudah mencapai maksimal
    updateAddRunningTextButton();
}

function removeRunningTextInput(id) {
    var element = document.getElementById('runningTextGroup' + id);
    if (element) {
        element.remove();
        runningTextCount--;
        
        // Reset ID untuk elemen yang tersisa
        reorderRunningTextInputs();
        
        // Update tombol
        updateAddRunningTextButton();
        
        showToast('Running Text dihapus', 'info');
    }
}

function reorderRunningTextInputs() {
    var groups = document.querySelectorAll('#runningTextInputs .running-text-group');
    runningTextCount = groups.length + 1; // +1 untuk RT1 yang bukan .running-text-group
    
    groups.forEach((group, index) => {
        var groupId = index + 2; // Mulai dari RT2
        group.id = 'runningTextGroup' + groupId;
        
        // Update label
        var label = group.querySelector('.form-label');
        if (label) {
            label.textContent = 'Running Text ' + groupId;
        }
        
        // Update input id
        var input = group.querySelector('input');
        if (input) {
            input.id = 'runningText' + groupId;
            input.placeholder = 'Masukkan running text ' + groupId;
        }
        
        // Update tombol hapus
        var deleteBtn = group.querySelector('.delete-running-text-btn');
        if (deleteBtn) {
            deleteBtn.setAttribute('onclick', 'removeRunningTextInput(' + groupId + ')');
        }
    });
}

function updateAddRunningTextButton() {
    var addBtn = document.getElementById('addRunningTextBtn');
    if (addBtn) {
        if (runningTextCount >= 3) {
            addBtn.style.display = 'none';
        } else {
            addBtn.style.display = 'block';
        }
    }
}

function loadSavedRunningText(index) {
    try {
        var savedSettings = localStorage.getItem('masjidSettings');
        if (savedSettings) {
            var settings = JSON.parse(savedSettings);
            var runningTexts = settings.runningTexts || [];
            
            if (runningTexts[index - 1]) {
                document.getElementById('runningText' + index).value = runningTexts[index - 1];
            }
        }
    } catch (e) {
        console.log('Error loading running text:', e);
    }
}

// Update fungsi saveRunningText() untuk handle multiple running texts
function saveRunningText() {
    try {
        var runningTexts = [];
        
        // Kumpulkan semua running text
        for (var i = 1; i <= runningTextCount; i++) {
            var input = document.getElementById('runningText' + i);
            if (input && input.value.trim() !== '') {
                runningTexts.push(input.value.trim());
            }
        }
        
        // Gabungkan dengan pemisah " || "
        var combinedText = runningTexts.join(' || ');
        
        // Simpan ke settings
        settings.runningText = combinedText;
        settings.runningTexts = runningTexts; // Simpan array juga untuk load nanti
        
        if (saveSettings()) {
            updateRunningTextUI();
            showToast('‚úÖ Running text berhasil disimpan!', 'success');
            
            // Tutup offcanvas
            var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasRunningText'));
            if (offcanvas) {
                offcanvas.hide();
            }
        }
    } catch (e) {
        console.log('Error saveRunningText:', e);
        showToast('‚ùå Gagal menyimpan running text!', 'danger');
    }
}


function loadRunningTextsFromSettings() {
    try {
        // Reset running text count
        runningTextCount = 1;
        
        // Clear semua input kecuali yang pertama
        var inputsContainer = document.getElementById('runningTextInputs');
        var firstInput = document.getElementById('runningText1');
        
        if (inputsContainer && firstInput) {
            // Set RT1
            var runningTexts = settings.runningTexts || [];
            if (runningTexts.length > 0) {
                firstInput.value = runningTexts[0] || '';
            } else if (settings.runningText) {
                firstInput.value = settings.runningText;
            }
            
            // Hapus input tambahan yang ada
            var additionalGroups = inputsContainer.querySelectorAll('.running-text-group');
            additionalGroups.forEach(group => group.remove());
            
            // Buat input untuk RT2 dan RT3 jika ada
            for (var i = 1; i < runningTexts.length; i++) {
                runningTextCount++;
                
                var newInputGroup = document.createElement('div');
                newInputGroup.className = 'mb-3 running-text-group';
                newInputGroup.id = 'runningTextGroup' + runningTextCount;
                
                newInputGroup.innerHTML = `
                    <div class="form-label-container">
                        <label class="form-label fw-bold">Running Text ${runningTextCount}</label>
                        <button type="button" class="delete-running-text-btn" onclick="removeRunningTextInput(${runningTextCount})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <input type="text" class="form-control" id="runningText${runningTextCount}" 
                           value="${runningTexts[i] || ''}" placeholder="Masukkan running text ${runningTextCount}">
                `;
                
                inputsContainer.appendChild(newInputGroup);
            }
            
            // Update tombol tambah
            updateAddRunningTextButton();
        }
    } catch (e) {
        console.log('Error loadRunningTextsFromSettings:', e);
    }
}


</script>
</body>
</html>

